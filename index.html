<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ±æ»‘æ¨¡æ‹Ÿå™¨ </title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS æ ·å¼åŒº (ä¿æŒä¸å˜) */
        :root {
          /* å¼ºåˆ¶æ‰€æœ‰äº¤äº’å…ƒç´ ä½¿ç”¨åŒæ ·çš„å­—ä½“ */
button, input, select, textarea {
    font-family: 'Noto Sans SC', -apple-system, sans-serif;
}
            --ins-color: #a29bfe; --art-color: #fab1a0; --bod-color: #81ecec;
            --pow-color: #ff7675; --hp-high: #55efc4; --hp-mid: #ffeaa7;
            --hp-low: #d63031; --bg-color: #2d3436; --panel-bg: #dfe6e9;
            --text-main: #2d3436;
        }
        body {
    /* ä¼˜å…ˆä½¿ç”¨ä¸‹è½½çš„æ€æºé»‘ä½“ï¼Œå¦‚æœä¸‹è½½å¤±è´¥åˆ™ä½¿ç”¨ç³»ç»Ÿå¤‡ç”¨é»‘ä½“ */
    font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-main);
    margin: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
   -webkit-text-size-adjust: 100%; /* ç¦æ­¢ iOS è‡ªåŠ¨è°ƒæ•´å­—ä½“å¤§å° */
    text-size-adjust: 100%;         /* ç¦æ­¢å®‰å“è‡ªåŠ¨è°ƒæ•´å­—ä½“å¤§å° */
}
        #game-container { width: 100%; max-width: 600px; background-color: white; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); overflow: hidden; min-height: 80vh; position: relative; display: flex; flex-direction: column; }
        .screen { display: none; padding: 20px; flex: 1; overflow-y: auto; animation: fadeIn 0.5s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .btn { display: block; width: 100%; padding: 13px; margin: 8px 0; border: none; border-radius: 5px; background-color: #74b9ff; color: white; font-size: 13.5px; cursor: pointer; transition: background 0.2s; text-align: left; }
        .btn:hover { background-color: #0984e3; }
        .btn:disabled { background-color: #b2bec3; cursor: not-allowed; }
        .btn small { display: block; font-size: 12px; opacity: 0.8; margin-top: 4px; }
        .stat-row { margin-bottom: 12px; display: flex; align-items: center; font-size: 13px; }
        .stat-label { width: 60px; font-weight: bold; }
        .progress-bg { flex-grow: 1; height: 14px; background: #b2bec3; border-radius: 8px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; transition: width 0.5s ease; }
        .stat-val { width: 50px; text-align: right; font-size: 10px; margin-left: 5px; }
        .marker { position: absolute; top: 0; bottom: 0; width: 1px; border-left: 1px dashed rgba(255,255,255,0.6); z-index: 2; }
        .top-bar { background: #636e72; color: white; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 13px; display: flex; justify-content: space-between; }
      .control-panel { font-size: 13px; }
      .training-grid { font-size: 13px; }
        .control-panel { background: var(--panel-bg); padding: 15px; border-radius: 8px; margin-top: 15px; }
        .training-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .mode-select { display: flex; gap: 5px; margin-top: 10px; }
        .mode-btn { flex: 1; padding: 8px; font-size: 11px; border: 1px solid #b2bec3; background: white; cursor: pointer; }
        .mode-btn.selected { background: #2d3436; color: white; }
        .log-box { height: 120px; overflow-y: auto; background: #f1f2f6; border: 1px solid #dcdde1; padding: 8px; font-size: 11px; margin-top: 15px; border-radius: 5px; }
        .log-item { border-bottom: 1px solid #dfe6e9; padding: 4px 0; }
        .modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 80%; max-width: 400px; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; color: var(--text-main); }
        .modal-title { font-size: 15px; font-weight: bold; margin-bottom: 10px; }
        .modal-content { font-size: 13px; margin-bottom: 20px; line-height: 1.5; text-align: left;}
        .modal-btn { background: #74b9ff; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .modal-btn:hover { background: #0984e3; }
        .shop-modal-content { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 100; color: white; padding: 20px; display: none; overflow-y: auto; font-size: 14px;}
        .shop-item { border: 1px solid #636e72; padding: 10px; margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 13px;}
        h2 { border-bottom: 2px solid #b2bec3; padding-bottom: 10px; margin-top: 0; }
           /* --- é¦–é¡µç‰¹å®šæ ·å¼æ’å…¥ --- */
        .start-screen {
            display: none;           /* åˆå§‹éšè—ï¼Œç”±JSæ§åˆ¶æ˜¾ç¤º */
            flex-direction: column;  /* å…ƒç´ å‚ç›´æ’åˆ— */
            justify-content: center; /* å†…å®¹å‚ç›´å±…ä¸­ */
            align-items: center;     /* å†…å®¹æ°´å¹³å±…ä¸­ */
            height: 100%;            /* å æ»¡å®¹å™¨ */
            padding: 40px;
            text-align: center;      /* æ–‡å­—å±…ä¸­ */
            background: linear-gradient(to bottom, #ffffff, #dfe6e9); /* å†°é›ªæ¸å˜è‰² */
        }
        .start-screen.active { display: flex; } /* å½“æ¿€æ´»æ—¶ï¼Œä½¿ç”¨ Flex å¸ƒå±€æ˜¾ç¤º */

        .main-title { font-size: 40px; font-weight: 900; margin: 0; color: #2d3436; letter-spacing: 2px; text-shadow: 2px 2px 0px #b2bec3; }
        .sub-title { font-size: 14px; color: #636e72; margin-top: 5px; font-weight: 300; }
        .credits { font-size: 12px; color: #b2bec3; margin-top: 5px; margin-bottom: 40px; font-style: italic; }
        .intro-text { font-size: 13px; line-height: 1.8; color: #555; margin-bottom: 50px; max-width: 85%; background: rgba(255,255,255,0.6); padding: 15px; border-radius: 8px; }
        
        .start-btn {
            background-color: #74b9ff; color: white; font-size: 18px; font-weight: bold; padding: 15px 50px;
            border: none; border-radius: 30px; cursor: pointer; box-shadow: 0 5px 15px rgba(116, 185, 255, 0.4);
            transition: all 0.3s ease; animation: pulse 2s infinite;
        }
        .start-btn:hover { background-color: #0984e3; transform: translateY(-2px); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
      /* --- ä¸“é—¨æ§åˆ¶åºç« å‰§æƒ…æ–‡å­—çš„å¤§å° --- */
        #screen-prologue p {
            font-size: 15px;       /* è¿™é‡Œä¿®æ”¹æ•°å­—ï¼š18px, 20px, 24px ç­‰ */
            line-height: 1.8;      /* è¿™é‡Œä¿®æ”¹è¡Œé«˜ï¼šè®©å­—ä¹‹é—´ä¸è¦å¤ªæŒ¤ */
            font-weight: bold;   /* å¦‚æœæƒ³åŠ ç²—ï¼Œè¿™é‡Œæ”¹æˆ bold */
            color: #2d3436;        /* æ–‡å­—é¢œè‰² */
            margin-bottom: 30px;   /* æ–‡å­—å’Œä¸‹é¢é€‰é¡¹æŒ‰é’®çš„è·ç¦» */
        }
      /* --- ä¸“é—¨æ§åˆ¶ç»“å±€æè¿°æ–‡å­—ï¼ˆend-descï¼‰çš„å¤§å°å’Œæ ·å¼ --- */
        #end-desc {
            font-size: 14px; 
          font-weight: bold; /* ä¿®æ”¹å­—å·ï¼šå»ºè®®è®¾ä¸º 20px æˆ– 22pxï¼Œè®©ç»“å±€æ›´æœ‰å†²å‡»åŠ› */
            line-height: 1.8;          /* è¡Œé—´è·ï¼šè®©å¤§æ®µæ–‡å­—è¯»èµ·æ¥æ›´è½»æ¾ */
            color: #2d3436;            /* æ–‡å­—é¢œè‰² */
            text-align: center;        /* ç»“å±€æ–‡å­—é€šå¸¸å»ºè®®å±…ä¸­æ˜¾ç¤º */
            margin: 20px auto;         /* ä¸Šä¸‹å¤–è¾¹è· 20pxï¼Œå·¦å³è‡ªåŠ¨å±…ä¸­ */
            max-width: 85%;            /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢æ–‡å­—åœ¨å®½å±ä¸Šå¤ªæ•£ */
            white-space: pre-wrap;     /* å…è®¸ä¿ç•™æ¢è¡Œç¬¦ */
        }
      /* --- ä¸“é—¨æ§åˆ¶ç¬¬ä¸€ç« åŠåç»­ç« èŠ‚ï¼šå‰§æƒ…æè¿°æ–‡å­—çš„å†…å®¹ --- */
        #story-text {
            font-size: 14px; 
          font-weight: bold;  /* ä¿®æ”¹å­—å·ï¼šå»ºè®®æ¯”åºç« ç¨å¾®å°ä¸€ç‚¹ï¼Œ18px æˆ– 20px */
            line-height: 1.7;      /* è¡Œé—´è·ï¼šç¡®ä¿æ‰‹æœºé˜…è¯»ä¸åƒåŠ› */
            color: #2d3436;        /* é¢œè‰²ï¼šæ·±ç°è‰²ï¼Œä¿æŠ¤è§†åŠ› */
            margin: 15px 0;        /* ä¸Šä¸‹é—´è· */
            text-align: left;      /* å·¦å¯¹é½ */
        }
            /* --- æ–°å¢ï¼šæ‰‹æœºç«¯å¼ºåˆ¶å…¨å±é€‚é… --- */
        @media screen and (max-width: 600px) {
            body {
                padding: 0;       /* æ ¸å¿ƒä¿®æ”¹ï¼šå»é™¤å››å‘¨ç•™ç™½ */
                align-items: flex-start; /* é˜²æ­¢å‚ç›´å±…ä¸­å¯¼è‡´å¤´éƒ¨è¢«åˆ‡æ‰ */
                background-color: white; /* æ‰‹æœºç«¯èƒŒæ™¯ç›´æ¥å˜ç™½ï¼Œé˜²æ­¢åˆ˜æµ·å±æ¼å‡ºé»‘è¾¹ */
            }

            #game-container {
                width: 100%;      /* å®½åº¦å æ»¡ */
                height: 100vh;    /* æ ¸å¿ƒä¿®æ”¹ï¼šé«˜åº¦å¼ºåˆ¶å æ»¡ 100% è§†å£é«˜åº¦ */
                min-height: 100vh;
                max-width: 100%;  /* å–æ¶ˆæœ€å¤§å®½åº¦é™åˆ¶ */
                border-radius: 0; /* æ ¸å¿ƒä¿®æ”¹ï¼šå»é™¤åœ†è§’ï¼Œå˜æˆç›´è§’å…¨å± */
                box-shadow: none; /* å»é™¤é˜´å½±ï¼Œæ‰‹æœºç«¯ä¸éœ€è¦ç«‹ä½“æ„Ÿ */
            }
            
            /* é’ˆå¯¹æ‰‹æœºç«¯ä¼˜åŒ–ä¸€ä¸‹å†…å®¹åŒºåŸŸçš„æ»šåŠ¨ */
            .content {
                flex: 1;          /* ç¡®ä¿ä¸­é—´å†…å®¹åŒºè‡ªåŠ¨æ’‘å¼€ */
                overflow-y: auto; /* å…è®¸å†…å®¹è¿‡å¤šæ—¶æ»šåŠ¨ */
            }
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="screen-start" class="screen start-screen active"> <h1 class="main-title">èŠ±æ»‘æ¨¡æ‹Ÿå™¨</h1>
        <div class="sub-title">Figure Skating Simulator</div>
        <div class="credits">By Flames and Gemini</div>
        <div class="intro-text">
            ä½ å°†æ‰®æ¼”ä¸€åèŠ±æ»‘è¿åŠ¨å‘˜ï¼Œ<br>
            ä»é’æ¶©å°‘å¹´èµ·æ­¥ï¼Œåœ¨æ±—æ°´ä¸ä¼¤ç—›ä¸­ç£¨ç ºæŠ€è‰ºã€‚<br>
            è§„åˆ’è®­ç»ƒã€ç®¡ç†ä¼¤ç—…ã€è§’é€èµ›åœºï¼Œ<br>
            å‘ç€å†¬å¥¥ä¼šçš„æœ€é«˜é¢†å¥–å°å‘èµ·å†²å‡»ã€‚<br>
            <br>
            <strong>ä½ çš„æ¯ä¸€æ¬¡èµ·è·³ï¼Œéƒ½å°†ä¹¦å†™å±äºä½ çš„å†°ä¸Šä¼ å¥‡ã€‚</strong>
        </div>
        <button class="start-btn" onclick="Game.startToPrologue()">è¸ä¸Šå†°åœº</button> 
    </div>

    <div id="screen-prologue" class="screen">
        <h2>å‡ºèº«é€‰æ‹©</h2>
        <div id="prologue-step-content"></div>
    </div>

    <div id="screen-chapter1" class="screen">
        <h2>å†°åˆƒåˆç—•</h2>
        <div id="story-text" style="line-height: 1.6; margin-bottom: 20px;"></div>
        <div id="story-options"></div>
    </div>

    <div id="screen-dashboard" class="screen">
        <div class="top-bar">
            <div>
                <div id="ui-year">é’å¹´ç»„ ç¬¬1å¹´</div>
                <div id="ui-target">è·å‡ç»„è¿˜æœ‰ 4 å¹´</div>
            </div>
            <div style="text-align: right;">
                <div id="ui-medals">ğŸ¥‡0 ğŸ¥ˆ0 ğŸ¥‰0</div>
                <div id="ui-res">ğŸ’° 0</div>
            </div>
        </div>

        <div id="ui-stats"></div>

        <div class="control-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <strong>è®­ç»ƒé¡¹ç›®</strong>
                <span id="ui-actions-left">å‰©ä½™æ¬¡æ•°: 4</span>
            </div>
            <div class="training-grid" id="training-buttons"></div>
            
            <div style="margin-top:10px;">
                <strong>å¼ºåº¦æ¨¡å¼ (HPæ¶ˆè€—)</strong>
                <div class="mode-select" id="intensity-selector"></div>
            </div>

            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button id="btn-do-train" class="btn" onclick="Game.handleTraining()">å¼€å§‹è®­ç»ƒ</button>
                <button class="btn" style="background:#e17055" onclick="UI.openShop()">è¡¥ç»™å•†åº—</button>
                <button id="btn-phase" class="btn" style="background:#6c5ce7" onclick="Game.advancePhase()">å¼€å§‹èµ›å­£</button>
            </div>
       </div>

        <div class="log-box" id="activity-log"></div>
    </div>
    
    <div id="modal-shop" class="shop-modal-content">
        <h2>è¡¥ç»™å•†åº— <button onclick="UI.closeShopModal()" style="float:right; background:transparent; border:none; color:white; font-size: 18px;">Ã—</button></h2>
        <p>å½“å‰èµ„é‡‘: <span id="shop-money">0</span></p>
        <div id="shop-list"></div>
    </div>

    <div id="modal-alert" class="modal-overlay">
        <div class="modal-box">
            <div id="modal-title" class="modal-title">æç¤º</div>
            <div id="modal-content" class="modal-content">å†…å®¹</div>
            <button id="modal-btn" class="modal-btn">ç¡®å®š</button>
        </div>
    </div>

    <div id="modal-event" class="shop-modal-content" style="background: rgba(0,0,0,0.95);">
        <h2 id="event-title">éšæœºäº‹ä»¶</h2>
        <p id="event-desc" style="margin: 20px 0; line-height: 1.5; font-size: 14px;"></p>
        <div id="event-options"></div>
    </div>

    <div id="screen-ending" class="screen" style="text-align: center;">
        <h1 id="end-title" style="font-size: 26px; margin-top: 40px;"></h1>
        <div id="end-badges" style="margin: 20px 0; color: #ff7675;"></div>
        <p id="end-desc" style="text-align: left; background: #f5f5f5; padding: 20px; border-radius: 8px; color: #333;"></p>
        <div id="end-stats-summary" style="margin-top:20px; font-weight:bold;"></div>
        <button class="btn" onclick="Game.restartGame()" style="margin-top: 30px;">é‡æ–°å¼€å§‹èŒä¸šç”Ÿæ¶¯</button>
    </div>
</div>

<script>
/**
 * ============================================================
 * 1. é…ç½®æ•°æ® (CONFIG)
 * ============================================================
 */
const CONFIG = {
    prologue: [
        {
            title: "å‡ºç”Ÿåœ°",
            desc: "ä¸€åˆ‡çš„å¼€å§‹ï¼Œåœ¨äºä½ çå¼€çœ¼æ—¶çœ‹åˆ°çš„åŸå¸‚ã€‚",
            options: [
                { txt: "å†°é›ªé‡é•‡", res: 2, bod: 3, ins: 1, pow: 0, tag: "è¿™é‡Œçš„å­©å­è¿˜æ²¡å­¦ä¼šèµ°è·¯ï¼Œå…ˆå­¦ä¼šäº†æ»‘å†°ã€‚" },
                { txt: "æ ¸å¿ƒéƒ½ä¼š", res: 6, bod: 0, ins: 0, pow: 0, tag: "æœ€é¡¶çº§çš„ä¿±ä¹éƒ¨ï¼Œä¹Ÿæ˜¯æœ€æ˜‚è´µçš„é—¨ç¥¨ã€‚" },
                { txt: "å—æ–¹ç»¿æ´²", res: 4, bod: 0, ins: 0, pow: 2, tag: "åœ¨å•†åœºçš„å–§åš£ä¸­ï¼Œä½ ç‹¬è‡ªå¯»æ‰¾å†°é¢çš„å®é™ã€‚" }
            ]
        },
        {
            title: "å®¶å¢ƒèƒŒæ™¯",
            desc: "çˆ¶æ¯æ˜¯ä½ æœ€åšå®çš„åç›¾ï¼Œæˆ–æ˜¯æœ€æ²‰é‡çš„æœŸå¾…ã€‚",
            options: [
                { txt: "å†°äºŒä»£", res: 4, ins: 4, art: 0, bod: 0, tag: "ä½ ä¼ æ‰¿ç€çˆ¶æ¯çš„æŠ€å·§ï¼Œä¹ŸèƒŒè´Ÿç€å®¶äººçš„æœŸæœ›ã€‚", isGen2: true },
                { txt: "ä¹¦é¦™é—¨ç¬¬", res: 2, ins: 0, art: 6, bod: 0, tag: "ä»–ä»¬å¸Œæœ›ä½ æ‹¥æœ‰å¼ºå¥çš„ä½“é­„ï¼ŒåŒæ—¶ä¹Ÿå…¼é¡¾å­¦ä¸šã€‚" },
                { txt: "å¯’é—¨å¥‡æ‰", res: 1, ins: 0, art: 0, bod: 7, tag: "å®¶é‡Œä¸å®½è£•ï¼Œä½†ä»–ä»¬ç»™äº†ä½ ä¸€å‰¯æœ€å¼ºå¥çš„èº«ä½“" }
            ]
        },
        {
            title: "å¤©èµ‹ç‰¹è´¨",
            desc: "æœ€åï¼Œå®¡è§†ä½ è‡ªå·±ã€‚",
            options: [
                { txt: "æ˜“ç¢å¼¹ç°§", tag: "æƒŠäººçš„çˆ†å‘ï¼Œä¼´éšç€ç»ç’ƒèˆ¬çš„è„†å¼±ã€‚",pow: 12, art: 2, bod: -2, ins: 4, traitId: 'glass' },
                { txt: "é’¢é“å¦å…‹", tag: "å¹³åº¸ä½†åšéŸ§ï¼Œä½ æ°¸è¿œæ˜¯å†°åœºä¸Šç»ƒå¾—æœ€ä¹…çš„é‚£ä¸€ä¸ªã€‚",pow: 4, art: 2, bod: 8, ins: 2, traitId: 'tank' },
                { txt: "è‰ºæœ¯æ°´æ¯", tag: "èº«ä½“æŸ”è½¯å¦‚ç»¸ï¼Œä½ æ˜¯å¤©ç”Ÿçš„è¡¨æ¼”è€…ã€‚",pow: 0, art: 12, bod: 2, ins: 2, traitId: 'jelly' },
                { txt: "å†·é™å¤§è„‘", tag: "æè‡´çš„ç¨³å®šï¼Œä½ åœ¨å†°åœºä¸Šä»æœªè¿·å¤±è¿‡æ–¹å‘ã€‚",pow: 4, art: 4, bod: 2, ins: 6, traitId: 'brain' }
            ]
        }
    ],
    traitMultipliers: {
        'glass': { pow: 1.2, art: 1.0, bod: 0.8, ins: 1.0 },
        'tank': { pow: 1.0, art: 0.8, bod: 1.2, ins: 1.0 },
        'jelly': { pow: 0.8, art: 1.2, bod: 1.0, ins: 1.0 },
        'brain': { pow: 0.9, art: 1.0, bod: 1.0, ins: 1.2 }
    },
    trainings: [
        { id: 'step', name: 'æ»‘è¡Œæ­¥æ³•', gain: { ins: 3, bod: 1 }, desc: 'çµæ„Ÿ+3 ä½“é­„+1' },
        { id: 'jump', name: 'è·³è·ƒä¸“é¡¹', gain: { pow: 3, art: 1 }, desc: 'çˆ†å‘+3 è‰ºæœ¯+1' },
        { id: 'dance', name: 'èˆè¹ˆåˆä¹', gain: { art: 3, ins: 1 }, desc: 'è‰ºæœ¯+3 çµæ„Ÿ+1' },
        { id: 'land', name: 'é™†åœ°ä½“èƒ½', gain: { bod: 3, pow: 1 }, desc: 'ä½“é­„+3 çˆ†å‘+1' },
        { id: 'rest', name: 'å½»åº•ä¼‘æ¯', gain: { hp: 15 }, desc: 'HP +15' }
    ],
    shopItems: [
        { id: 'honey', name: 'ç§˜åˆ¶èœ‚èœœæ°´', cost: 80, desc: 'HP+10 (æ¯å¹´é™è´­3æ¬¡)', oneTime: false, limit: 3 },
        { id: 'shield', name: 'é«˜çº§æŠ¤å…·', cost: 300, desc: 'ä¸‹æ¬¡å—ä¼¤æ¦‚ç‡å‡åŠ', oneTime: false },
        { id: 'massage', name: 'æ·±å±‚ç­‹è†œæª', cost: 800, desc: 'HP+25ï¼ˆå¤§å®¹é‡å›è¡€ï¼‰', oneTime: false },
        { id: 'lucky_charm', name: 'å¥½è¿çº¢ç»³',  cost: 5000, desc: 'ä¸‹åœºæ¯”èµ›éšæœºæ³¢åŠ¨ä¸‹é™æå‡ï¼Œä¸ä¼šå‘æŒ¥å¤±å¸¸', oneTime: false },
        { id: 'ballet_class', name: 'å¤§å¸ˆçº§èŠ­è•¾è¯¾', cost: 1000, desc: 'è‰ºæœ¯+3,ï¼ˆæå‡è‰ºæœ¯è¡¨è¾¾)',  oneTime: false, limit: 1 },
        { id: 'cat_cafe', name: 'æ’¸çŒ«åˆ¸', cost: 500, desc: 'å¿ƒæ€+10ï¼Œæ²¡æœ‰ä»€ä¹ˆæ˜¯ä¸€åªå°çŒ«å’ªä¸èƒ½æ²»æ„ˆçš„ã€‚', oneTime: false },
        // æˆå¹´ç»„/ç‰¹æ®Šé™åˆ¶
        { id: 'skates', name: 'é¡¶çº§è¿›å£å†°é‹', cost: 4000, desc: 'æ°¸ä¹…: çµæ„ŸåŠ æˆ+10%', oneTime: true, minGroup: 'adult' },
        { id: 'medical', name: 'è¿åŠ¨åŒ»å­¦è¯Šç–—', cost: 1500, desc: 'æ¸…é™¤ä¸€æ¬¡HPä¸Šé™è¡°å‡', oneTime: false, minGroup: 'adult' },
        { id: 'diet', name: 'ç§äººè¥å…»å¸ˆ', cost: 2000, desc: 'æ°¸ä¹…: æ¯å¹´å›è¡€+10', oneTime: true, minGroup: 'adult' },
        { id: 'camp', name: 'è‡ªè´¹å¤–è®­', cost: 3000, desc: 'å½“å¹´è®­ç»ƒæ•ˆæœ+20% (æ¯å¹´é™è´­1æ¬¡)', oneTime: false, minGroup: 'adult', limit: 1 },
        { id: 'psychology', name: 'å¿ƒç†è¾…å¯¼å¸ˆ', cost: 800, desc: 'çµæ„Ÿ+1', oneTime: false, minGroup: 'youth', limit: 1 },
        { id: 'costume', name: 'é«˜å®šè€ƒæ–¯æ»•', cost: 3000, desc: 'è‰ºæœ¯+3', oneTime: false, minGroup: 'adult', limit: 1 },
        { id: 'master_class', name: 'ä¼ å¥‡å¤§å¸ˆè¯¾', cost: 6000, desc: 'å…¨å±æ€§ç«‹å³æå‡ 2 ç‚¹', oneTime: false, minGroup: 'adult' , limit: 1},
        { id: 'movie_ticket', name: 'ç”µå½±ç¥¨', cost: 300, desc: 'å¿ƒæ€+5ï¼Œçµæ„Ÿ+1ï¼Œä¸€åœºå¥½ç”µå½±è®©ä½ çµæ„Ÿè¿¸å‘ã€‚', oneTime: false },
       { id: 'short_trip', name: 'çŸ­æœŸæ—…è¡Œ', cost: 3000, desc: 'å¿ƒæ€+20ï¼ŒHP+5ï¼Œä¸€æ¬¡è¯´èµ°å°±èµ°çš„æ—…è¡Œã€‚ï¼ˆæ¯å¹´é™è´­1æ¬¡ï¼‰', oneTime: false, limit: 1 },
            ],
    matchConfig: {
        'youth': {
            'qualify': { base: 120, range: 20 },
            'jgp': { base: 120, range: 30 },
            'final': { base: 140, range: 20 },
            'nationals': { base: 120, range: 20 },
            'worlds': { base: 130, range: 30 },
            'olympics_youth': { base: 130, range: 30 }
        },
        'adult': {
            'qualify': { base: 150, range: 40 },
            'gp': { base: 180, range: 80 },
            'final': { base: 240, range: 40 },
            'nationals': { base: 160, range: 30 },
            '4cc': { base: 180, range: 90 },
            'asiangames': { base: 200, range: 70 },
            'worlds': { base: 175, range: 100 },
            'olympics': { base: 240, range: 40 }
        }
    },
    countries: ["ä¸­å›½", "ç¾å›½", "æ—¥æœ¬", "åŠ æ‹¿å¤§", "æ³•å›½", "æ„å¤§åˆ©", "æ³¢å…°", "æ³°å›½", "é˜¿å¡æ‹œç–†"],
  // =================================================================
    // ã€æ–°å¢ã€‘åŸºç¡€ç¯å¢ƒå™¨æ•°æ®åº“
    // =================================================================
    // æ¯ä¸€ä¸ª"ç¯å¢ƒ"éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«äº†å®ƒçš„æ‰€æœ‰ä¿¡æ¯
    // è¿™é‡Œçš„æ¦‚ç‡æ˜¯ç›¸å¯¹æ¦‚ç‡ï¼Œç¨‹åºä¼šæ ¹æ®è¿™äº›æ¦‚ç‡åœ¨è§¦å‘åè¿›è¡ŒæŠ½å¥–
    matchModifiers: [
        {
            id: 'hard_ice',
            name: 'å†°é¢åç¡¬',
            probability: 0.13, // è§¦å‘æ¦‚ç‡ 13%
            desc: "èµ›åœºå†°é¢åç¡¬ï¼Œè¿™å¯¹é€‰æ‰‹çš„èº«ä½“å†²å‡»å’Œä½“èƒ½æ¶ˆè€—æ˜¯å·¨å¤§çš„è€ƒéªŒï¼Œä½†ä½“é­„å¼ºå¥çš„é€‰æ‰‹èƒ½æ›´å¥½åœ°ç¨³ä½åŠ¨ä½œã€‚",
            // æ•ˆæœå¯¹è±¡ï¼ŒåŒ…å«äº†æ‰€æœ‰æ•°å€¼ä¸Šçš„å˜åŒ–
            effect: {
                sp_bod: 0.1, fs_bod: 0.1,   // SPå’ŒFSçš„ä½“é­„æƒé‡+0.1
                sp_art: -0.1, fs_art: -0.1, // SPå’ŒFSçš„è‰ºæœ¯æƒé‡-0.1
                extraHpCost: 5             // é¢å¤–HPæ¶ˆè€—
            }
        },
        {
            id: 'soft_ice',
            name: 'å†°é¢åè½¯',
            probability: 0.12, // 12%
            desc: "å†°é¢è½»å¾®èåŒ–ï¼Œæ»‘è¡Œé˜»åŠ›å¤§ï¼Œèµ·è·³é£é™©é«˜ï¼Œä½†è½å†°ç¼“å†²æ•ˆæœæ›´å¥½ã€‚",
            effect: {
                sp_pow: 0.1, fs_pow: 0.1,
                sp_art: -0.1, fs_art: -0.1,
                extraHpCost: 5
            }
        },
        {
            id: 'high_altitude',
            name: 'é«˜åŸèµ›åœº',
            probability: 0.10, // 10%
            desc: "æ¯”èµ›åœ¨é«˜åŸåŸå¸‚ä¸¾è¡Œï¼Œç¨€è–„çš„ç©ºæ°”è®©æ¯ä¸€æ¬¡å‘¼å¸éƒ½å˜å¾—æ²‰é‡ï¼Œä½“åŠ›é¢ä¸´ä¸¥å³»æŒ‘æˆ˜ã€‚",
            effect: {
                // è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šæ•ˆæœï¼Œæˆ‘ä»¬ä¼šç”¨ id åœ¨ä»£ç é‡Œä¸“é—¨å¤„ç†
                isSpecial: 'altitude_hp_effect'
            }
        },
        {
            id: 'misty_ice',
            name: 'ä»™æ°”ç¼­ç»•',
            probability: 0.05, // 5%
            desc: "é›¾æ°”å¼¥æ¼«åœ¨æ•´ä¸ªå†°é¢ä¸Šï¼Œæ¯ä¸€ä¸ªæŠ€æœ¯åŠ¨ä½œéƒ½å¿…é¡»å°å¿ƒç¿¼ç¿¼ã€‚",
            effect: {
                sp_ins: 0.15, fs_ins: 0.15,
                sp_pow: -0.05, fs_pow: -0.05,
                sp_art: -0.05, fs_art: -0.05,
                sp_bod: -0.05, fs_bod: -0.05
            }
        },
        {
            id: 'fanatical_crowd',
            name: 'ç‹‚çƒ­è§‚ä¼—',
            probability: 0.15, // 15%
            desc: "ç°åœºè§‚ä¼—çš„åŠ æ²¹å£°æ’å±±å€’æµ·ï¼Œå°†æå¤§é¼“èˆå¯Œæœ‰è¡¨ç°åŠ›çš„é€‰æ‰‹ã€‚",
            effect: {
                sp_art: 0.1, fs_art: 0.1,
                sp_ins: -0.1, fs_ins: -0.1
            }
        },
        {
            id: 'cold_crowd',
            name: 'å†·æ·¡è§‚ä¼—',
            probability: 0.15, // 15%
            desc: "è§‚ä¼—ä¼¼ä¹å¯¹æœ¬åœºæ¯”èµ›çš„å¦ä¸€ä½é€‰æ‰‹æ›´æ„Ÿå…´è¶£ï¼Œç°åœºæ°›å›´æœ‰äº›å†·æ·¡ã€‚",
            effect: {
                sp_ins: 0.1, fs_ins: 0.1,
                sp_art: -0.1, fs_art: -0.1
            },
            // ã€ç‰¹æ®Šã€‘ä¸ºåè½¬æœºåˆ¶é¢„ç•™çš„æ•°æ®
            reversal: {
                condition: (state) => state.fame > 4000 && state.art > 60 && Math.random() < 0.3,
                desc: "â€¦â€¦ä½†ä½ ç”¨å®Œç¾çš„è¡¨ç°èµ¢å›äº†è§‚ä¼—çš„å¿ƒï¼",
                effect: {
                    sp_ins: -0.12, fs_ins: -0.12, // æ³¨æ„ï¼Œè¿™é‡Œæ˜¯è¦†ç›–åŸæ•ˆæœ
                    sp_art: 0.12, fs_art: 0.12,
                    score_bonus: 5 // é¢å¤–çš„åˆ†æ•°åŠ æˆ
                }
            }
        },
        {
            id: 'strict_tech',
            name: 'æŠ€æœ¯ä¸¥è‹›',
            probability: 0.10, // 10%
            desc: "æœ¬åœºæ¯”èµ›çš„æŠ€æœ¯è£åˆ¤ä»¥ä¸¥æ ¼è‘—ç§°ï¼Œä»»ä½•å¾®å°çš„ç‘•ç–µéƒ½å¯èƒ½è¢«æŠ“ä½å¹¶æ‰£åˆ†ã€‚",
            effect: {
                sp_pow: 0.09, fs_pow: 0.09,
                sp_ins: 0.09, fs_ins: 0.09,
                sp_art: -0.18, fs_art: -0.18
            }
        },
        {
            id: 'artistic_preference',
            name: 'è‰ºæœ¯åå¥½',
            probability: 0.10, // 10%
            desc: "æ®é—»ï¼Œæœ¬åœºæ¯”èµ›çš„è£åˆ¤ç»„æ›´æ¬£èµå¯Œæœ‰æ„ŸæŸ“åŠ›çš„è‰ºæœ¯è¡¨ç°ã€‚",
            effect: {
                sp_art: 0.18, fs_art: 0.18,
                sp_pow: -0.09, fs_pow: -0.09,
                sp_ins: -0.09, fs_ins: -0.09
            }
        },
        {
            id: 'p_follows_t',
            name: 'PéšTèµ°',
            probability: 0.10, // 10%
            desc: "æœ¬åœºæ¯”èµ›çš„è£åˆ¤ä¼¼ä¹è®¤ä¸ºé«˜éš¾åº¦çš„æŠ€æœ¯ä¹Ÿåº”é…ä¸Šé«˜æ°´å‡†çš„è¡¨æ¼”ï¼Œåä¹‹äº¦ç„¶ã€‚",
            effect: {
                // åªå½±å“FS
                fs_pow: 0.09,
                fs_bod: 0.09,
                fs_art: -0.18
            }
        }
    ]
};

  /* ============================================================
 * 1.5. æ–°å¢ï¼šè”ç³»äººäº‹ä»¶æ•°æ®åº“ (CONTACT_EVENTS)
 * ============================================================ */
const CONTACT_EVENTS = {
    family: {
        id: 'family',
        name: 'ç›¸äº²ç›¸çˆ±ä¸€å®¶äºº',
        probability: 0.5,
        events: [
            {
                name: "ã€è§†é¢‘é€šè¯ã€‘",text: "ç¾¤èŠâ€œç›¸äº²ç›¸çˆ±ä¸€å®¶äººâ€å‘æ¥æ¶ˆæ¯ï¼Œå®¶äººé‚€è¯·ä½ è§†é¢‘é€šè¯ã€‚",
                trigger: (s) => s.phase === 'offseason',
                cost: 3,
                effect: (s) => {
                    if (s.psyche > 50) Game.updatePsyche(-5);
                    else Game.updatePsyche(5);
                },
                return: "å’Œå®¶äººç•…èŠä¸€å°æ—¶ï¼Œä½ æ„Ÿåˆ°å¹¸ç¦ä¸”å……å®ã€‚ï¼ˆHP-3ï¼Œå¿ƒæ€æ¢å¤5ï¼‰"
            },
            {
                name: "ã€çœ‹çœ‹çŒ«çŒ«ã€‘",text: "å»å†°åœºçš„è·¯ä¸Šçœ‹åˆ°ä¸€åªå°çŒ«ï¼Œä½ å¼€å§‹æƒ³å¿µè‡ªå·±çš„å® ç‰©ã€‚éœ€è¦è®©å¦ˆå¦ˆä¸ºä½ æ‹ä¸€å¼ å°çŒ«ç…§ç‰‡å—ï¼Ÿ",
                trigger: (s) => s.phase === 'offseason',
                cost: 3,
                effect: (s) => {
                     if (s.psyche > 50) Game.updatePsyche(-5);
                     else Game.updatePsyche(5);
                },
                return: "å¦ˆå¦ˆåªæŠ“æ‹åˆ°å°çŒ«ä¸“å¿ƒè‡´å¿—æ¶ˆç­çŒ«ç²®çš„èº«å½±ï¼Œä½ æ„Ÿè§‰å®ƒåˆèƒ–äº†ã€‚ï¼ˆHP-3ï¼Œå¿ƒæ€æ¢å¤5ï¼‰"
            },
            {
                name: "ã€å€¾è¯‰çƒ¦æ¼ã€‘",text: "æœ€è¿‘å¿ƒæƒ…ä¼¼ä¹ä¸å¤ªç¾å¦™ï¼Œä½ è¿«åˆ‡åœ°æƒ³æ‰¾äººå€¾è¯‰ä¸€äºŒã€‚",
                trigger: (s) => s.phase === 'offseason',
                cost: 5,
                effect: (s) => {
                     if (s.psyche > 50) Game.updatePsyche(-5);
                     else Game.updatePsyche(5);
                },
                return: "å®¶äººå€¾å¬äº†ä½ çš„çƒ¦æ¼ï¼Œä»–ä»¬çš„æ¸©æŸ”è®©ä½ å¹³é™ä¸‹æ¥ã€‚ï¼ˆHP-3ï¼Œå¿ƒæ€æ¢å¤5ï¼‰"
            },
            {
                name: "ã€åˆ†äº«è¶£äº‹ã€‘",text: "ä¼‘èµ›æœŸçš„ç”Ÿæ´»è§„å¾‹ä½†ä¸ç¼ºä¹è¶£ï¼Œæˆ–è®¸å¯ä»¥ä¸å®¶äººåˆ†äº«è¿™ä»½å¿«ä¹â€¦â€¦",
                trigger: (s) => s.phase === 'offseason',
                cost: 3,
                effect: (s) => {
                     if (s.psyche > 50) Game.updatePsyche(-5);
                     else Game.updatePsyche(5);
                },
                return: "ä¼‘èµ›æœŸçš„ç”Ÿæ´»ä¸°å¯Œå¤šå½©ï¼Œä»–ä»¬å¬å¾—æ´¥æ´¥æœ‰å‘³ã€‚ï¼ˆHP-3ï¼Œå¿ƒæ€æ¢å¤5ï¼‰"
            },
            {
                name: "ã€æ¯”èµ›é£æ™¯ã€‘",text: "æ¯åˆ°ä¸€ä¸ªæ–°çš„åŸå¸‚æ¯”èµ›ï¼Œä½ éƒ½ä¼šæ‹ä¸‹é£æ™¯å‘ç»™å®¶äººâ€¦â€¦",
                trigger: (s) => s.phase === 'season',
                cost: 3,
                effect: (s) => {
                     if (s.psyche > 50) Game.updatePsyche(-5);
                     else Game.updatePsyche(5);
                },
                return: "å½“è¿åŠ¨å‘˜çš„å¥½å¤„å°±æ˜¯èƒ½çœ‹åˆ°ä¸–ç•Œå„åœ°çš„é£æ™¯ï¼Œç°åœ¨ä½ çš„å®¶äººä»¬ä¹Ÿèƒ½å¤Ÿå’Œä½ ä¸€èµ·æ¬£èµäº†ã€‚ï¼ˆHP-3ï¼Œå¿ƒæ€æ¢å¤5ï¼‰"
            }
        ]
    },
    teammate: {
        id: 'teammate',
        name: 'é˜Ÿå‹',
        probability: 0.2,
        events: [
            {
                name: "ã€ç›¸çº¦è®­ç»ƒã€‘",text: "é˜Ÿå‹å‘æ¥æ¶ˆæ¯ï¼šå‡æœŸåˆ«å·æ‡’ï¼Œæ˜å¤©å†°åœºè§ï¼Ÿ",
                trigger: (s) => s.phase === 'offseason',
                cost: 20,
                effect: (s) => {
                    Game.updatePsyche(-5);
                    s.bod += 3;
                    s.pow += 2;
                },
                return: "çœ‹ç€é˜Ÿå‹åŠªåŠ›è®­ç»ƒçš„èº«å½±ï¼Œè®­ç»ƒæ›´åŠªåŠ›äº†ã€‚ï¼ˆçˆ†å‘+2ï¼Œä½“é­„+3ï¼ŒHP-20ï¼‰"
            },
            {
                name: "ã€èµ›å‰èŠå¤©ã€‘",text: "èµ›å‰çƒ­èº«ï¼Œä½ çœ‹ç€é˜Ÿå‹ï¼Œçªç„¶æƒ³å’Œå¥¹è¯´äº›ä»€ä¹ˆâ€¦â€¦",
                trigger: (s) => s.group === 'adult' && s.phase === 'season',
                cost: 3,
                options: [
                    {
                        label: "äº’æ”¾ç‹ è¯",
                        effect: (s) => {
                            if (Math.random() < 0.5) {
                                Game.updatePsyche(10);
                                return "é˜Ÿå‹çš„è¯è¯­æ¿€èµ·äº†ä½ çš„æ–—å¿—ï¼Œä½ åšä¿¡è‡ªå·±ä¸€å®šèƒ½å¤Ÿå®Œç¾å‘æŒ¥ã€‚ï¼ˆå¿ƒæ€+10ï¼‰";
                            } else {
                                Game.updatePsyche(-10);
                                return "é˜Ÿå‹çš„è¯è®©ä½ æ›´ç”Ÿç„¦è™‘ï¼Œä½ ä¸ç¦æ‹…å¿§è‡ªå·±çš„å‘æŒ¥ã€‚ï¼ˆå¿ƒæ€-10ï¼‰";
                            }
                        }
                    },
                    {
                        label: "äº’ç›¸é¼“åŠ²",
                        effect: (s) => {
                            s.ins += 1;
                            if (s.psyche > 50) Game.updatePsyche(-5);
                            else Game.updatePsyche(5);
                            return "è‡ªç”±æ»‘ç»“æŸåä½ æœ›å‘è§‚ä¼—å¸­ï¼Œçœ‹è§é˜Ÿå‹æŒ¥èˆç€å›½æ——ä¸ºä½ å‘å–Šã€‚ï¼ˆå¿ƒæ€æ¢å¤5ï¼Œçµæ„Ÿ+1ï¼‰";
                        }
                    }
                ]
            }
        ]
    },
    coach: {
        id: 'coach',
        name: 'æ•™ç»ƒ',
        probability: 0.5,
        events: [
            {
                name: "ã€è¯·æ±‚åŠ ç»ƒã€‘",text: "ä½ ä¸»åŠ¨å‘æ¶ˆæ¯ç»™æ•™ç»ƒï¼šæˆ‘æƒ³é’ˆå¯¹å¼±é¡¹è¿›è¡Œç‰¹è®­ã€‚",
                trigger: (s) => s.phase === 'offseason',
                cost: 0,
                effect: (s) => {
                    if (Math.random() < 0.7) {
                        s.bod += 1;
                        s.pow += 1;
                        s.hp -= 15;
                        return "æ•™ç»ƒé’ˆå¯¹ä½ çš„è–„å¼±ä¹‹å¤„ä¸ºä½ å®‰æ’äº†é¢å¤–è®­ç»ƒï¼Œä½†ä¹Ÿæé†’ä½ æ³¨æ„èº«ä½“å¥åº·ã€‚ï¼ˆHP-15ï¼Œä½“é­„+1ï¼Œçˆ†å‘+1ï¼‰";
                    } else {
                        s.hp += 5;
                        return "â€œä½ éœ€è¦ä¼‘æ¯ã€‚â€æ•™ç»ƒæ‹’ç»äº†ä½ çš„æè®®ã€‚ï¼ˆHP+5ï¼‰";
                    }
                }
            },
            {
                name: "ã€è®­ç»ƒè®¡åˆ’ã€‘",text: "æ•™ç»ƒæŠŠä½ å«åˆ°åŠå…¬å®¤ï¼Œå•†è®¨ä½ çš„ä¸“å±è®­ç»ƒæ–¹æ¡ˆã€‚",
                trigger: (s) => s.phase === 'offseason',
                cost: 0,
                effect: (s) => {
                    s.hp -= 10;
                    s.ins += 1;
                },
                return: "å’Œæ•™ç»ƒå•†è®®äº†æœªæ¥çš„è®­ç»ƒé‡ç‚¹ï¼Œæ€è·¯æ›´æ¸…æ™°äº†ã€‚ï¼ˆHP-5ï¼Œçµæ„Ÿ+1ï¼‰"
            }
        ]
    },
    doctor: {
        id: 'doctor',
        name: 'é˜ŸåŒ»',
        probability: 0.4,
        events: [
            {
                name: "ã€ä¼¤ç—…ç®¡ç†ã€‘", text: "ä¼‘èµ›æœŸéš¾å¾—ç©ºé—²ï¼Œä½ é¢„çº¦äº†é˜ŸåŒ»è¿›è¡Œå…¨é¢ä½“æ£€ä¸ç†ç–—ã€‚",
                trigger: (s) => s.phase === 'offseason',
                cost: 0,
                effect: (s) => {
                    s.injuryImmunity = true;s.money -= 200;s.hp += 5; // è®¾å®šå¹´åº¦è®­ç»ƒå—ä¼¤å…ç–«
                },
                return: "ç»è¿‡é˜ŸåŒ»çš„ä¸“ä¸šè¯„ä¼°å’ŒæŒ‡å¯¼ï¼Œä½ å¯¹è‡ªå·±çš„èº«ä½“çŠ¶å†µäº†å¦‚æŒ‡æŒã€‚ï¼ˆæœ¬å¹´åº¦è®­ç»ƒå—ä¼¤æ¦‚ç‡é™ä½ï¼‰"
            }
        ]
    },
    psychologist: {
        id: 'psychologist',
        name: 'å¿ƒç†å’¨è¯¢å¸ˆ', 
        probability: 0.2,
        events: [
            {
                name: "ã€å¿ƒç†ç–å¯¼ã€‘",text: "å¿ƒç†åŒ»ç”Ÿå‘æ¥æ¶ˆæ¯ï¼šæœ€è¿‘æ„Ÿè§‰å¦‚ä½•ï¼Ÿè¦ä¸è¦æ¥èŠèŠï¼Ÿ",
                trigger: (s) => s.phase === 'offseason',
                cost: 8,
                effect: (s) => {
                    if (s.psyche > 50) Game.updatePsyche(-10);
                    else Game.updatePsyche(10);
                },
                return: "å’Œå’¨è¯¢å¸ˆäº¤æµä¸€ç•ªï¼Œä½ å¿ƒä¸­çš„é‡æ‹…å‡è½»äº†ä¸å°‘ã€‚ï¼ˆå¿ƒæ€æ¢å¤10ï¼‰"
            }
        ]
    }
};
  
/* ============================================================
   2. æ¸¸æˆçŠ¶æ€ (State)
   ============================================================ */
const InitialState = {
    step: 0, origin: '', isGen2: false, trait: '', 
    pow: 10, art: 10, bod: 10, ins: 10,psyche: 50, hp: 100,
    resPoints: 0, money: 0, fame: 0, 
    chapter: 0, year: 1, group: 'youth', phase: 'offseason', actionsLeft: 4,
    medals: { dG:0, dS:0, dB:0, iG:0, iS:0, iB:0 },
    hpCapMalus: 0, 
    modifiers: { shield: false, skates: false, diet: false, camp: false },
    shopLimits: { honey: 0, camp: 0 },
    selectedTrainingId: null, selectedIntensity: 'normal', 
    hasOlympicGold: false, heavyInjuryCount: 0, luckyFish: false, ended: false,
    currentSeasonMatches: [], 
    seasonQualified: false,
    gpRankings: [],
    tempMatchScoreBonus: 0,
    // --- æ–°å¢çŠ¶æ€ ---
    activeContactEvents: [], // å­˜å‚¨æœ¬å¹´åº¦è¢«è§¦å‘çš„è”ç³»äººäº‹ä»¶
    triggeredEventCount: 0,  // è®°å½•æœ¬å¹´åº¦å·²è§¦å‘çš„â€œéšæœºäº‹ä»¶æ± â€äº‹ä»¶æ•°é‡
    injuryImmunity: false,   // è®°å½•æœ¬å¹´åº¦æ˜¯å¦å…ç–«è®­ç»ƒå—ä¼¤
  // --- æ–°å¢ï¼šèµ›å­£ç»Ÿè®¡ ---
    trainsThisSeason: 0,
    restsThisSeason: 0,
    injuriesThisSeason: 0,
    qualifiedForGPFinalThisSeason: false,
    medalsThisSeason: { G: 0, S: 0, B: 0 },
  lastMatchResult: { name: '', rank: 0 }, // è®°å½•ä¸Šä¸€åœºæ¯”èµ›çš„ç»“æœ
    hasBadgeSoftHeart: false,               // è®°å½•æ˜¯å¦è·å¾—â€œå¿ƒè½¯ã®ç¥â€æˆå°±
  consoledRival: false, // è®°å½•ç©å®¶æ˜¯å¦å®‰æ…°è¿‡å¤±åˆ©çš„å¯¹æ‰‹
  // --- æ–°å¢ï¼šå…¨å±€ç”Ÿæ¶¯ç»Ÿè®¡ ---
    totalRestsAllTime: 0,
  triggeredGlobalEvents: [],// ç”¨äºè®°å½•æ•´ä¸ªæ¸¸æˆç”Ÿæ¶¯ä¸­åªè§¦å‘ä¸€æ¬¡çš„äº‹ä»¶ID
};

let State = JSON.parse(JSON.stringify(InitialState));

/* ============================================================
   3. éšæœºäº‹ä»¶ç®¡ç†å™¨ (é›†æˆæ‰€æœ‰æ–°äº‹ä»¶)
   ============================================================ */
const EventManager = {
    event
  : [],
    init: function() {
        this.eventPool = [];
        
        // 1. ç²‰ä¸è§é¢ä¼š
        this.addNewEvent({
            id: "fan_meet",
            trigger: function(s) { return s.fame > 500 && Math.random() < 0.15 && s.phase === 'offseason'; },
            probability: 1.0,
            text: "ç²‰ä¸å¸Œæœ›èƒ½ä¸¾åŠè§é¢ä¼šï¼Œä½†è¿™ä¼šæ¶ˆè€—ä¸€äº›èµ„é‡‘ã€‚",
            options: [
                { label: "ç­”åº”", effect: (s)=>{ s.fame+=50; s.money-=1000; s.hp -= 15; return "ç²‰ä¸ä»¬éå¸¸å¼€å¿ƒï¼ (åæ°”+50, èµ„-1000, HP-15)"; } },
                { label: "æ‹’ç» ", effect: (s)=>{ s.ins += 1; return "ä½ é€‰æ‹©ä¸“æ³¨äºè®­ç»ƒ(çµæ„Ÿ+1)ã€‚"; } }
            ]
        });

      this.addNewEvent({
    id: "competitor_meltdown",
        globalOneTime: true,
    // è§¦å‘å™¨ï¼šèµ›å­£ä¸­ã€åæ°”å¤Ÿé«˜ã€ä¸”ä¸Šä¸€åœºæ˜¯æŒ‡å®šå¤§èµ›çš„å† å†›
    trigger: function(s) {
        if (s.phase !== 'season' || s.fame <= 4000) return false;
       // æ£€æŸ¥ä¸Šä¸€åœºæ¯”èµ›æ˜¯å¦æ˜¯å¤§èµ›å† å†›
        const majorWins = ["ä¸–é”¦èµ›", "äºšå†¬ä¼š", "GPæ€»å†³èµ›", "å†¬å¥¥ä¼š"];
        const wasMajorChampion = majorWins.some(m => s.lastMatchResult.name.includes(m)) && s.lastMatchResult.rank === 1;
       // 0.25çš„è§¦å‘æ¦‚ç‡ï¼Œé¿å…æ¯æ¬¡éƒ½å‡ºç°
        return wasMajorChampion && Math.random() < 0.2;
    },
    probability: 1.0, // é€šè¿‡triggeræ§åˆ¶æ¦‚ç‡ï¼Œè¿™é‡Œè®¾ä¸º1.0
    text: "ä¸€ä½èµ›å‰å¤‡å—ç©ç›®çš„é€‰æ‰‹æ„å¤–å‘æŒ¥å¤±å¸¸ï¼Œåˆšåˆšåœ¨åŒåœºç«æŠ€ä¸­è·èƒœçš„ä½ å†³å®šâ€¦â€¦",
    options: [
        { 
            label: "é»˜é»˜ç¦»å¼€", 
            effect: (s) => { 
                s.ins += 1;
                return "ä½ é€‰æ‹©å°†ç©ºé—´ç•™ç»™å¥¹ç‹¬è‡ªæ¶ˆåŒ–æƒ…ç»ªã€‚å¯¹ç«æŠ€ä½“è‚²çš„æ®‹é…·ï¼Œä½ æœ‰äº†æ›´æ·±çš„ç†è§£ã€‚ï¼ˆçµæ„Ÿ+1ï¼‰"; 
            } 
        },
        { 
            label: "æ‹¥æŠ±å®‰æ…°", 
            effect: (s) => { 
                s.art += 1;s.fame += 1
                s.hasBadgeSoftHeart = true; // è·å¾—æ–°æˆå°±
              s.consoledRival = true; // <-- å‡èµ·æ——å¸œï¼è®°å½•ä¸‹è¿™ä¸ªå–„ä¸¾
              return "ä½ èµ°ä¸Šå‰ï¼Œç»™äº†å¥¹ä¸€ä¸ªæ— å£°çš„æ‹¥æŠ±ã€‚å¥¹æŠ¬èµ·å¤´ï¼Œä¹Ÿå¯¹ä½ é€ä¸Šäº†çœŸè¯šçš„ç¥è´ºã€‚ä½ çš„å–„æ„ï¼Œæˆ–è®¸ä¼šåœ¨æœªæ¥å¾—åˆ°å›åº”ã€‚ï¼ˆè‰ºæœ¯+1ï¼Œåå£°+100ï¼‰"; 
            }  }
    ]
});
      
      this.addNewEvent({
    id: "rival_returns_favor",
    globalOneTime: true, // è¿™ä¸ªå›æŠ¥äº‹ä»¶æœ¬èº«ä¹Ÿåªå‘ç”Ÿä¸€æ¬¡
    
    // è§¦å‘å™¨ï¼š
    // 1. å¿…é¡»å®‰æ…°è¿‡å¯¹æ‰‹ (æ——å¸œå‡èµ·)
    // 2. å¿…é¡»åœ¨èµ›å­£ä¸­
    // 3. éšæœºæ¦‚ç‡ï¼Œé¿å…ç«‹å³è§¦å‘
    trigger: function(s) {
        if (!s.consoledRival || s.phase !== 'season') {
            return false;
        }
        // 40%çš„è§¦å‘æ¦‚ç‡ï¼Œè®©å®ƒçš„å‡ºç°å¸¦æœ‰ä¸€ç‚¹æƒŠå–œ
        return Math.random() < 0.4;
    },
    probability: 1.0, // ç”±triggeræ§åˆ¶æ¦‚ç‡

    text: "åœ¨åˆä¸€åœºå¤§èµ›çš„èµ›å‰è®­ç»ƒä¸­ï¼Œä½ å†æ¬¡è§åˆ°äº†é‚£ä½æ›¾è¢«ä½ å®‰æ…°è¿‡çš„é€‰æ‰‹ã€‚å¥¹çœ‹èµ·æ¥çŠ¶æ€ä¸é”™ï¼Œä¸»åŠ¨èµ°è¿‡æ¥å‘ä½ æ‰“æ‹›å‘¼ï¼Œâ€œè°¢è°¢ä½ ä¸Šæ¬¡çš„å®‰æ…°ã€‚â€",
    
    options: [
        { 
            label: "ä¸¾æ‰‹ä¹‹åŠ³", 
            effect: (s) => {
                // 1. ç»™äºˆå¥–åŠ±ï¼šä¸ºä¸‹ä¸€åœºæ¯”èµ›å¢åŠ ä¸´æ—¶åˆ†æ•°
                if (!s.tempMatchScoreBonus) s.tempMatchScoreBonus = 0;
                s.tempMatchScoreBonus += 3;
                
                // 2. æ”¾ä¸‹æ——å¸œï¼šå°†æ——å¸œé‡ç½®ä¸ºfalseï¼Œè¡¨ç¤ºè¿™ä¸ªäº‹ä»¶é“¾å·²ç»å®Œæˆ
                s.consoledRival = false; 
           return "ä½ ä»¬å†æ¬¡æ‹¥æŠ±ã€‚åœ¨è¿™ç‰‡å†°åœºï¼Œä½ ä»¬æ˜¯å¯¹æ‰‹ï¼Œæ›´æ˜¯æœ‹å‹ã€‚ä½“è‚²ç²¾ç¥åœ¨è¿™ä¸€åˆ»æ— æ¯”é—ªè€€ã€‚ï¼ˆä¸‹åœºæ¯”èµ›æ€»åˆ†+3ï¼‰";
            } 
        }
    ]
});
      
        // 2. èµ›å‰çŠ¶æ€
        this.addNewEvent({
            id: "pre_match_boost",
            trigger: function(s) { return s.phase === 'season' && Math.random() < 0.2; },
            probability: 1.0,
            text: "èµ›å‰çƒ­èº«æ—¶ï¼Œä½ æ„Ÿè§‰å†°åˆ€å’Œå†°é¢å®Œç¾å¥‘åˆï¼ŒçŠ¶æ€å¥‡ä½³ï¼",
            options: [
                { 
                    label: "ä¿æŒä¸“æ³¨", 
                    effect: (s) => { 
                        if (!s.tempMatchScoreBonus) s.tempMatchScoreBonus = 0;
                        s.tempMatchScoreBonus = 5; 
                        return "ä½ æ„Ÿè§‰å……æ»¡äº†åŠ›é‡ï¼Œè¿™ä¸€åœºç¨³äº†ï¼ (æœ¬åœºæ¯”èµ›åˆ†æ•°+5)"; 
                    } 
                }
            ]
        });

        // 3. æ·±å¤œåŠ ç»ƒ
        this.addNewEvent({
            id: "midnight_train",
            trigger: function(s) { return s.hp > 50 && Math.random() < 0.1; },
            probability: 1.0,
            text: "æ·±å¤œçš„å†°åœºç©ºæ— ä¸€äººï¼Œä½ çªç„¶æƒ³ç•™ä¸‹æ¥å¤šç»ƒä¸€ä¼šã€‚",
            options: [
                { label: "æŒ‘æˆ˜æé™", effect: (s) => { s.pow += 2; s.hp -= 10; return "è™½ç„¶å¾ˆç´¯ï¼Œä½†ä½ çš„è·³è·ƒç²¾è¿›äº†ï¼(çˆ†å‘+2, HP-10)"; } },
                { label: "é€‚å¯è€Œæ­¢", effect: (s) => { s.ins += 1; return "ä½ é™é™è§‚å¯Ÿç€å†°é¢ï¼Œå¯¹æ»‘è¡Œæœ‰äº†æ–°æ„Ÿæ‚Ÿã€‚ (çµæ„Ÿ+1)"; } }
            ]
        });

        // 4. ç¼–èˆçµæ„Ÿ
        this.addNewEvent({
            id: "ballet_watch",
            trigger: function(s) { return s.phase === 'offseason' && s.art > 30; },
            probability: 0.2,
            text: "ä½ åœ¨ä¼‘æ¯æ—¥çœ‹äº†ä¸€åœºé¡¶çº§çš„èŠ­è•¾èˆè¡¨æ¼”ï¼Œå¯¹è‚¢ä½“å»¶ä¼¸æœ‰äº†æ–°çš„é¢†æ‚Ÿã€‚",
            options: [
                { label: "æ¨¡ä»¿å­¦ä¹ ", effect: (s)=>{ s.art += 2; s.hp -= 10; return "ä½ çš„è¡¨ç°åŠ›æ›´è¿›äº†ä¸€æ­¥ï¼(è‰ºæœ¯+2, HP-10)"; } },
                { label: "å•çº¯æ¬£èµ", effect: (s)=>{ s.ins += 1; return "å¿ƒæƒ…æ„‰æ‚¦ï¼Œçµæ„Ÿæ¶Œç°ã€‚ (çµæ„Ÿ+1)"; } }
            ]
        });

        // 5. å†°åˆ€æ•…éšœ
        this.addNewEvent({
            id: "skate_issue",
            trigger: function(s) { return s.phase === 'season' && Math.random() < 0.08; },
            probability: 1.0,
            text: "ç³Ÿç³•ï¼åœ¨èµ›å‰æ£€æŸ¥æ—¶ï¼Œä½ å‘ç°å†°åˆ€çš„åˆƒå£æœ‰ä¸€å¤„å¾®å°çš„å´©è£‚ï¼Œè¿™å¯èƒ½ä¼šå½±å“ä½ çš„ç¨³å®šæ€§ã€‚",
            options: [
                { label: "å‹‰å¼ºæ¯”èµ›", effect: (s) => { if(!s.tempMatchScoreBonus)s.tempMatchScoreBonus=0; s.tempMatchScoreBonus -= 8; return "ä½ å¿ƒé‡Œæœ‰äº›ä¸å®‰ï¼Œæ»‘è¡Œæ—¶å˜å¾—å°å¿ƒç¿¼ç¿¼ã€‚ (ä¸‹åœºæ¯”èµ›åˆ†æ•°-8)"; } },
                { label: "ç´§æ€¥ç£¨åˆ€", effect: (s) => { s.money -= 200; if(!s.tempMatchScoreBonus)s.tempMatchScoreBonus=0; s.tempMatchScoreBonus -= 2; return "èŠ±é’±æ‰¾æŠ€å¸ˆå¤„ç†äº†ï¼Œä½†æ‰‹æ„Ÿè¿˜æ˜¯å—äº†ç‚¹å½±å“ã€‚ (èµ„é‡‘-200, ä¸‹åœºæ¯”èµ›åˆ†æ•°-2)"; } }
            ]
        });

        // 6. å®¶ä¹¡åº”æ´
        this.addNewEvent({
            id: "hometown_support",
            trigger: function(s) { return s.phase === 'season' && s.fame > 200 && Math.random() < 0.12; },
            probability: 1.0,
            text: "çœ‹å°ä¸Šå“èµ·äº†å·¨å¤§çš„æ¬¢å‘¼å£°ï¼Œä½ çœ‹åˆ°äº†å®¶ä¹¡å†°è¿·ä»¬ä¸¾ç€çš„åº”æ´æ¨ªå¹…ã€‚",
            options: [
                { label: "å…¨åŠ›ä»¥èµ´", effect: (s) => { if(!s.tempMatchScoreBonus)s.tempMatchScoreBonus=0; s.tempMatchScoreBonus += 6; return "ä½ æ„Ÿåˆ°çƒ­è¡€æ²¸è…¾ï¼ŒçŠ¶æ€ç›´æ¥æ‹‰æ»¡ï¼ (ä¸‹åœºæ€»åˆ†+6)"; } }
            ]
        });

        // 7. é€‰æ›²buff
        this.addNewEvent({
            id: "music_bonus",
            trigger: function(s) { return s.phase === 'season' && Math.random() < 0.1; },
            probability: 1.0,
            text: "è£åˆ¤å¸­ä¸Šä¼¼ä¹æœ‰å‡ ä½è¯„å§”éå¸¸å–œæ¬¢ä½ è¿™èµ›å­£çš„é€‰æ›²ï¼Œä»–ä»¬æ­£éšç€éŸ³ä¹ç‚¹å¤´ã€‚",
            options: [
                { label: "æ²‰æµ¸è¡¨æ¼”", effect: (s) => { if(!s.tempMatchScoreBonus)s.tempMatchScoreBonus=0; s.tempMatchScoreBonus += 5; return "è‰ºæœ¯è¡¨ç°åˆ†ï¼ˆPCSï¼‰è·å¾—åŠ æˆï¼ (ä¸‹åœºæ€»åˆ†+5)"; } }
            ]
        });

        // 8. èº«ä½“é¢„è­¦
        this.addNewEvent({
            id: "injury_warning",
            trigger: function(s) { return s.hp < 50 && !s.modifiers.shield; },
            probability: 0.2,
            text: "æ—©æ™¨èµ·åºŠæ—¶ï¼Œä½ æ„Ÿè§‰è†ç›–éšéšä½œç—›ï¼Œæ•™ç»ƒå»ºè®®ä½ è°ƒæ•´è®¡åˆ’ã€‚",
            options: [
                { 
                    label: "åšæŒé«˜å¼ºåº¦", effect: (s)=>{ 
                    if(Math.random() < 0.3) { Game.handleInjury('light'); return "å“å“Ÿï¼è¿˜æ˜¯æ‹‰ä¼¤äº†ã€‚"; }
                    s.pow += 1; return "ä½ æŒºè¿‡å»äº†ï¼ŒåŠ›é‡æœ‰æ‰€å¢é•¿ï¼(çˆ†å‘+1)"; 
                } },
                { label: "ç†ç–—æ”¾æ¾", effect: (s)=>{ s.money -= 200; s.hp += 10; 
                    return "èº«ä½“æ˜¯é©å‘½çš„æœ¬é’±ã€‚ (èµ„é‡‘-200, HP+10)"; } }
            ]
        });

        // 9. å“ç‰Œä»£è¨€
        this.addNewEvent({
            id: "brand_deal",
            trigger: function(s) { return s.fame > 1000; },
            probability: 0.15,
            text: "ä¸€å®¶è¿åŠ¨å“ç‰Œçœ‹ä¸­äº†ä½ çš„æ½œåŠ›ï¼Œé‚€è¯·ä½ æ‹æ‘„ä¸€æ”¯ç®€çŸ­çš„å•†ä¸šå¹¿å‘Šã€‚",
            options: [
                { label: "æ¥å—ä»£è¨€", 
                    effect: (s)=>{ s.money += 400; s.fame += 50; s.hp += 10; return "ä½ åœ¨ç”µè§†ä¸Šéœ²è„¸äº†ï¼Œé’±åŒ…ä¹Ÿé¼“äº†ï¼ (èµ„é‡‘+400, åæ°”+50ï¼ŒHP-10)"; } },
                { label: "ä¸“æ³¨è®­ç»ƒ", effect: (s)=>{ s.pow += 2; return "ä½ æ‹’ç»äº†å–§åš£ï¼Œåœ¨å†°åœºæŒ¥æ±—å¦‚é›¨ã€‚ (çˆ†å‘+2)"; } }
            ]
        });

        // 10. å†°ä¸Šå¥‡ç¼˜
        this.addNewEvent({
            id: "ice_inspiration",
            trigger: function(s) { return s.ins < 20; },
            probability: 0.2,
            text: "ä½ åœ¨å®¤å¤–å†°åœºæ»‘å†°æ—¶ï¼Œçœ‹åˆ°ä¸€åªæ è¿‡å†°é¢çš„é£é¸Ÿï¼Œä¼¼ä¹æŠ“åˆ°äº†æŸç§èŠ‚å¥ã€‚",
            options: [
                { label: "å°è¯•ç¼–èˆ", 
                    effect: (s)=>{ s.ins += 2; return "ä¸€æ®µæ–°çš„æ­¥æ³•åœ¨è„‘æµ·ä¸­æˆå‹ã€‚ (çµæ„Ÿ+2)"; } },
                { label: "é»˜é»˜è®°ä¸‹", effect: (s)=>{ s.ins += 1; return "æœ‰äº›ä¸œè¥¿æ”¹å˜äº†ã€‚ (çµæ„Ÿ+1)"; } }
            ]
        });

        // ã€æ–°å¢ 1ã€‘ç‰ˆæƒå±æœº
        this.addNewEvent({
            id: "copyright_issue",
            trigger: function(s) { return s.group === 'adult' && s.phase === 'season' && Math.random() < 0.1; },
            probability: 1.0,
            text: "èµ›å‰ä½ çªç„¶æ”¶åˆ°æ¶ˆæ¯ï¼Œä½ çš„èŠ‚ç›®é…ä¹å› ç‰ˆæƒé—®é¢˜æ— æ³•ä½¿ç”¨ï¼",
          globalOneTime: true,
            options: [
                { 
                    label: "æ¢å›ä¸Šèµ›å­£èŠ‚ç›®", 
                    effect: (s) => { 
                        if (!s.tempMatchScoreBonus) s.tempMatchScoreBonus = 0;
                        s.tempMatchScoreBonus -= 5;
                        return "ä¸€å¼ å®‰å…¨ç‰Œã€‚ä½†è£åˆ¤å’Œè§‚ä¼—å·²ç»åŒå€¦ã€‚(PCS-5)"; 
                    } 
                },
                { 
                    label: "ç«‹åˆ»ç¼–æ’æ–°èŠ‚ç›®", 
                    effect: (s) => { 
                        s.money -= 500;
                        s.hp -= 10;
                        if (!s.tempMatchScoreBonus) s.tempMatchScoreBonus = 0;
                        s.tempMatchScoreBonus += 5;
                        return "è™½ç„¶åŒ†åŒ†å¿™å¿™ï¼Œä½†ä½ å‘è§‚ä¼—å±•ç¤ºäº†ä¸€å¥—æ–°å¥‡çš„èŠ‚ç›®ã€‚(èµ„é‡‘-500, HP-10, ä¸‹æ¬¡å¾—åˆ†+5)"; 
                    } 
                }
            ]
        });

        // ã€æ–°å¢ 2ã€‘å†°é‹è¢«å·
        this.addNewEvent({
            id: "skate_stolen",
            trigger: function(s) { return s.group === 'adult' && s.modifiers.camp && s.phase === 'season' && Math.random() < 0.05; },
            probability: 1.0,
            text: "ä½ çš„å†°é‹è¢«å·äº†ï¼ç¦»æ¯”èµ›åªå‰©å‡ ä¸ªå°æ—¶ï¼",
          globalOneTime: true,
            options: [
                { 
                    label: "å¯»æ‰¾æ–°å†°é‹å‚èµ›", 
                    effect: (s) => { 
                        s.money -= 1000;
                        s.hp -= 10;
                        s.bod += 3;
                        return "æ–°é‹å‚èµ›è®©ä½ ç—›è‹¦ä¸å ªï¼Œä½†ä½ åšæŒä¸‹æ¥äº†ã€‚(èµ„é‡‘-1000, HP-10, ä½“é­„+3)"; 
                    } 
                },
                { 
                    label: "ä¸´æ—¶é€€èµ›", 
                    effect: (s) => { 
                        s.money -= 500;
                        s.ins += 1;
                        if (!s.tempMatchScoreBonus) s.tempMatchScoreBonus = 0;
                        s.tempMatchScoreBonus -= 1000; // æå¤§çš„è´Ÿåˆ†æ¨¡æ‹Ÿå¾—åˆ†ä¸º0
                        return "æ²¡æœ‰å†°é‹å¦‚ä½•æ¯”èµ›ï¼Ÿä½ åªèƒ½æ‰“é“å›åºœã€‚(èµ„é‡‘-500, çµæ„Ÿ+1, ä¸‹æ¬¡æ¯”èµ›å¾—åˆ†è§†ä¸º0)"; 
                    } 
                }
            ]
        });

        // ã€æ–°å¢ 3ã€‘å¶é‡å¶åƒ
        this.addNewEvent({
            id: "meet_idol",
            trigger: function(s) { return s.phase === 'season' && Math.random() < 0.15; },
            probability: 1.0,
            text: "èµ›å‰å…¬å¼€è®­ç»ƒï¼Œä½ åœ¨å†°åœºé‡è§äº†è‡ªå·±æœ€å–œæ¬¢çš„è¿åŠ¨å‘˜ï¼",
            options: [
                { 
                    label: "é»˜é»˜æ¬£èµ", 
                    effect: (s) => { 
                        s.hp += 5;
                        s.art += 1;
                        return "ä½ æœ‰æ‰€æ„Ÿæ‚Ÿï¼Œå¿ƒæƒ…ä¹Ÿå˜å¥½äº†ã€‚(HP+5, è‰ºæœ¯+1)"; 
                    } 
                },
                { 
                    label: "è¦ä¸€å¼ åˆå½±", 
                    effect: (s) => { 
                        s.hp += 10;
                        return "è¦åˆ°äº†åˆå½±ï¼Œå¿ƒæƒ…å¤§å¥½ï¼(HP+10)"; 
                    } 
                }
            ]
        });

        // ã€æ–°å¢ 4ã€‘å†°æ¼”é‚€è¯·
        this.addNewEvent({
            id: "ice_show",
            trigger: function(s) { return s.art > 50 && s.phase === 'offseason' && Math.random() < 0.2; },
            probability: 1.0,
            text: "ä¸€å®¶çŸ¥åå†°æ¼”ä¸»åŠæ–¹é‚€è¯·ä½ å‚åŠ ä»–ä»¬çš„æ¼”å‡ºã€‚",
            options: [
                { 
                    label: "æ¬£ç„¶æ¥å—", 
                    effect: (s) => { 
                        s.hp -= 15;
                        s.art += 2;
                        s.fame += 50;
                        s.money += 1000;
                        return "æ›´å¤šäººè®¤è¯†äº†ä½ ï¼(HP-15, è‰ºæœ¯+2, åæ°”+50, èµ„é‡‘+1000)"; 
                    } 
                },
                { 
                    label: "å‹å–„æ‹’ç»", 
                    effect: (s) => { 
                        s.ins += 1;
                        return "ä½ è¿˜æ˜¯æƒ³ä¸“å¿ƒè®­ç»ƒã€‚(çµæ„Ÿ+1)"; 
                    } 
                }
            ]
        });

        // ã€æ–°å¢ 5ã€‘ç½‘ç»œå–·å­
        this.addNewEvent({
            id: "internet_troll",
            trigger: function(s) { return s.fame > 200 && Math.random() < 0.15; },
            probability: 1.0,
            text: "åœ¨æŸéŸ³ç¬¦è½¯ä»¶ä¸Šåˆ†äº«æ—¥å¸¸ç”Ÿæ´»ï¼Œæ”¶åˆ°ä¸€æ¡æ€’å–·ä½ ä¸åŠªåŠ›è®­ç»ƒçš„ç§ä¿¡ã€‚",
            options: [
                { 
                    label: "å–·å›å»", 
                    effect: (s) => { 
                        s.hp += 5;
                        return "ä½ å¿ƒæƒ…å¤§å¥½ï¼Œä½†å¯¹æ–¹æ›´æ„¤æ€’äº†ã€‚(HP+5)"; 
                    } 
                },
                { 
                    label: "èººå¹³ä»»å–·", 
                    effect: (s) => { 
                        s.hp -= 5;
                        s.bod += 1;
                        return "å¿ƒæƒ…æ²®ä¸§ï¼Œä½†è®­ç»ƒæ›´åŠªåŠ›äº†ï¼(HP-5, ä½“é­„+1)"; 
                    } 
                }
            ]
        });
      
      this.addNewEvent({
            id: "music-choice",
            trigger: function(s) { return s.phase === 'season' && s.art > 40 && Math.random() < 0.15; },
            probability: 1.0,
            text: "ä½ éœ€è¦é€‰æ‹©è‡ªå·±ä¸‹èµ›å­£çš„é€‰æ›²ã€‚",
            options: [
                { label: "é€‰æ‹©ç»å…¸èŠ±æ»‘æ›²ç›®", effect: (s) => { s.art += 1; return "åŒåœºæ’æ›²é€‰æ‰‹å¤ªå¤šï¼Œè¢«å†°è¿·åšæˆå¯¹æ¯”è§†é¢‘ï¼ˆè‰ºæœ¯+1ï¼‰"; } },
                { label: "é€‰æ‹©æ°‘æ—é£æ›²ç›®", effect: (s) => { s.ins += 1; s.fame += 500; return "è£åˆ¤ç»™äºˆäº†å’Œä½ çš„å›½ç±ç›¸é…çš„Påˆ†ï¼Œä½†ä½ çš„ä¼˜ç§€å†°è¿·éƒ½çœ‹åœ¨çœ¼é‡Œã€‚ï¼ˆåå£°+500ï¼Œçµæ„Ÿ+1ï¼‰"; } }
            ]
        });

this.addNewEvent({
            id: "dong-feng",
            trigger: function(s) { return s.phase === 'season' && s.fame > 5000 && Math.random() < 0.15; },
            probability: 1.0,
            text: "æ¯”èµ›ç»“æŸï¼Œè§‚ä¼—ç»™ä½ æ‰”äº†ä¸€ä¸ªä¸œé£é€ å‹çš„ç©å¶ã€‚",
          globalOneTime: true,
            options: [
                { label: "æ¡èµ·æ¥å¸¦åˆ°KCåŒº", effect: (s) => { s.pow += 2; s.hp -= 10; return "ç«Ÿç„¶æ‹¿ç€å¦‚æ­¤ä¸å½“çš„ç©å¶ï¼ISUå¯åŠ¨äº†å¯¹ä½ çš„è°ƒæŸ¥ï¼ï¼ˆåå£°+200ï¼Œè‰ºæœ¯+1ï¼‰"; } },
                { label: "å†·é™è·¯è¿‡", effect: (s) => { s.ins += 1; return "åœ¨æ— çŸ¥æ— è§‰ä¸­ï¼Œä½ èº²è¿‡äº†ä¸€åœºé£æš´ï¼ˆçµæ„Ÿ+1ï¼‰"; } }
            ]
        });

      this.addNewEvent({
            id: "pair",
            trigger: function(s) { return s.group === 'adult' && s.phase === 'offseason' && s.pow < 40 && Math.random() < 0.1; },
            probability: 1.0,
            text: "ä¼‘èµ›å­£ï¼Œæ•™ç»ƒå¿§æ„äºä½ çš„ç«æŠ€æ°´å¹³ï¼Œæå‡ºè®©ä½ å°è¯•è½¬å‘åŒäººæ»‘ã€‚",globalOneTime: true,
            options: [
                { label: "å¿ è¯šäºå•äººæ»‘", effect: (s) => { s.ins += 1;  return "ä½ æ¸…æ¥šè‡ªå·±çš„é•¿å¤„ï¼ŒåŒäººæ»‘è¿˜æ˜¯ç®—äº†å§ï¼ï¼ˆçµæ„Ÿ+1ï¼‰"; } },
                { label: "è¦ä¸çœŸè¯•è¯•ï¼Ÿ", effect: (s) => {if(Math.random() < 0.3) { UI.triggerEnding('pairs'); }
                    s.hp -= 20 ; return "è€—è´¹äº†å¤§é‡ç²¾åŠ›ï¼ï¼ˆHP-20ï¼‰"; } }
            ]
        });
      
      this.addNewEvent({
            id: "pair",
            trigger: function(s) { return s.phase === 'offseason' && s.pow < 40 && s.art > 70 && Math.random() < 0.1; },
            probability: 1.0,
            text: "æ•™ç»ƒå¿§æ„äºä½ çš„ç«æŠ€æ°´å¹³ï¼Œä½†å¨±ä¹å…¬å¸å‘ä½ æŠ›æ¥äº†æ©„æ¦„æã€‚",globalOneTime: true,
            options: [
                { label: "æˆ‘è¦æ»‘å†°", effect: (s) => { s.ins += 1;  return "æ¯”èµ·è·³èˆï¼Œä½ è¿˜æ˜¯æ›´å–œæ¬¢æ»‘å†°ã€‚ï¼ˆçµæ„Ÿ+1ï¼‰"; } },
                { label: "è½¬è¡Œä¹Ÿæ˜¯ä¸€ç§å‡ºè·¯", effect: (s) => {if(Math.random() < 0.3) { UI.triggerEnding('idol'); }
                    s.hp -= 20 ; s.art += 1; return "ä½ çš„è¡¨ç°åŠ›æ›´é—ªè€€äº†ï¼ï¼ˆHP-20ï¼Œè‰ºæœ¯+1ï¼‰"; } }
            ]
        });
      
      this.addNewEvent({
            id: "pair",
            trigger: function(s) { return s.group === 'adult' && s.phase === 'offseason' && s.money > 10000 && Math.random() < 0.1; },
            probability: 1.0,
            text: "åœ¨ä½ æƒŠäººçš„å•†ä¸šå¤´è„‘å’Œè´¢å¯Œç§¯ç´¯ä¹‹ä¸‹ï¼Œå†°åœºä¼¼ä¹å·²ç»æ— æ³•æŸç¼šä½ä½ çš„é‡å¿ƒã€‚",globalOneTime: true,
            options: [
                { label: "æˆ‘çš„é‡å¿ƒå°±åœ¨è¿™é‡Œ", effect: (s) => { s.ins += 1;  return "ä½ æ°¸è¿œæ¸…æ¥šçŸ¥é“è‡ªå·±æƒ³è¦ä»€ä¹ˆï¼ˆçµæ„Ÿ+1ï¼‰"; } },
                { label: "è®©ISUè§è¯†ä¸€ç•ªæˆ‘çš„å®åŠ›ï¼", effect: (s) => { UI.triggerEnding('boss'); } }
            ]
        });
      
this.addNewEvent({
            id: "growing",
            trigger: function(s) { return s.group === 'youth' && s.hp < 50 && !s.modifiers.shield; },
            probability: 0.2,
            text: "å‘è‚²å…³ä¸æœŸè€Œè‡³ï¼Œä½ çš„é‡å¿ƒæ­£åœ¨å‘ç”Ÿåç§»ã€‚",
            options: [
                { 
                    label: "åŠ å¤§è®­ç»ƒé‡å¯¹æŠ—å‘è‚²", effect: (s)=>{ 
                    if(Math.random() < 0.3) { s.bod += 2;s.hp -= 10; return "é¡¶ç€å‘è‚²è®­ç»ƒå¾ˆç—›è‹¦ï¼Œä½†ä½ æŒºè¿‡æ¥äº†ã€‚ï¼ˆHP-10ï¼Œä½“é­„+2ï¼‰"; }
                    s.hp -= 20 ; return "è®­ç»ƒå¼ºåº¦å¤ªå¤§ï¼Œä½ å—ä¼¤äº†ï¼ï¼ˆHP-20ï¼‰"; 
                } },
                { label: "ä¼‘å…»ç”Ÿæ¯", effect: (s)=>{ s.bod += 1; s.hp += 10; 
                    return "æœ‰æ—¶å€™ä¼‘æ¯æ˜¯æ›´å¥½çš„å‰è¿›ã€‚ (ä½“é­„+1ï¼ŒHP+10)"; } }
            ]
        });
      
      this.addNewEvent({
            id: "midnight_cry",
            trigger: function(s) { return s.psyche < 30 && s.phase === 'offseason'; },
            probability: 0.25, // æé«˜ä¸€ç‚¹æ¦‚ç‡ä»¥ä¾¿è§¦å‘
            text: "æ·±å¤œï¼Œä½ çœ‹ç€å¤©èŠ±æ¿ï¼Œçªç„¶è§‰å¾—ä¹‹å‰çš„åŠªåŠ›æ¯«æ— æ„ä¹‰ã€‚",
            options: [
                { 
                    label: "å¤§å“­ä¸€åœº", 
                    effect: (s) => { 
                        Game.updatePsyche(10); // ä½¿ç”¨å°è£…å‡½æ•°
                        s.hp -= 5; 
                        return "å°†æƒ…ç»ªå‘æ³„å‡ºæ¥è™½ç„¶å¾ˆç´¯ï¼Œä½ æ„Ÿè§‰å¥½å¤šäº†ã€‚(å¿ƒæ€+10, HP-5)"; 
                    } 
                },
                { 
                    label: "å’¬ç‰™ç¡¬æ‰›", 
                    effect: (s) => { 
                        Game.updatePsyche(-5); 
                        s.art += 1; 
                        return "ä½ åˆé»˜é»˜åº¦è¿‡äº†ä¸€ä¸ªéš¾çœ çš„å¤œæ™šã€‚æˆ–è®¸ç—›è‹¦ç¡®å®æ˜¯è‰ºæœ¯çš„æºæ³‰ï¼Œæ•™ç»ƒå¤¸èµä½ æœ€è¿‘è¡¨æ¼”è¿›æ­¥äº†ã€‚(å¿ƒæ€-5, è‰ºæœ¯+1)"; 
                    } 
                }
            ]
        });

        // ã€æ–°å¢ 2ã€‘ç‹‚çƒ­é‡‡è®¿ - å† å†›é¢„å®š
        this.addNewEvent({
            id: "interview_arrogant",
            trigger: function(s) { return s.psyche > 70 && s.phase === 'season'; },
            probability: 0.25,
            text: "èµ›å‰è®°è€…é‡‡è®¿ï¼Œä½ è„±å£è€Œå‡ºï¼šâ€œå† å†›å·²è¢«æˆ‘é¢„å®šã€‚â€",
            options: [
                { 
                    label: "èµ¶ç´§æ‰¾è¡¥", 
                    effect: (s) => { 
                        Game.updatePsyche(-5); 
                        s.ins += 1; 
                        return "ä½ æ€¥å¿™å‘è®°è€…è§£é‡Šé‚£æ˜¯ç©ç¬‘è¯ã€‚è™½ç„¶æœ‰äº›å°´å°¬ï¼Œä½†è‡³å°‘é¿å…äº†ä¸€åœºèˆ†è®ºé£æ³¢ã€‚(å¿ƒæ€-5, çµæ„Ÿ+1)"; 
                    } 
                },
                { 
                    label: "æˆ‘å°±æ˜¯è¿™ä¹ˆæƒ³çš„", 
                    effect: (s) => { 
                        Game.updatePsyche(5); 
                        s.fame += 100; 
                        return "è¿™æ®µé‡‡è®¿è§†é¢‘ç¬é—´å¼•çˆ†äº†ç½‘ç»œï¼æœ‰äººéª‚ä½ ç‹‚å¦„ï¼Œæœ‰äººå¤¸ä½ éœ¸æ°”ã€‚ä½†æ— è®ºå¦‚ä½•ï¼Œç°åœ¨çš„ä½ æ˜¯å…¨åœºçš„ç„¦ç‚¹ï¼Œæ‰€æœ‰äººéƒ½ç›¯ç€ä½ çš„ä¸‹ä¸€åœºæ¯”èµ›ã€‚(å¿ƒæ€+5, åæ°”+100)"; 
                    } 
                }
            ]
        });

this.addNewEvent({
            id: "lz-e",
            trigger: function(s) { return s.group === 'adult' && s.pow > 50 && Math.random() < 0.1; },
            probability: 1.0,
            text: "ä½ çš„é”™åˆƒLzå¤ªæ˜æ˜¾ï¼Œå·²ç»ä¸Šäº†è£åˆ¤é»‘åå•!",
            options: [
                { label: "åŠªåŠ›æ”¹åˆƒ", effect: (s) => { s.ins += 2; s.pow -= 1; s.bod += 1; return "å¯¹äºæˆå¹´é€‰æ‰‹ï¼Œæ”¹åˆƒä¸æ˜¯æ˜“äº‹ã€‚ï¼ˆçˆ†å‘-1ï¼Œçµæ„Ÿ+2ï¼Œä½“é­„+1ï¼‰"; } },
                { label: "ç»´æŒç°çŠ¶", effect: (s) => { s.ins -= 2; s.pow += 1; return "å‹¾æ‰‹çš„åˆ†å€¼è®©ä½ ä¸å¿ä¸¢å¼ƒè¿™ä¸ªè·³è·ƒï¼Œä½†æŠ€è£å·²ç»ç›¯ä¸Šä½ äº†ï¼ï¼ˆçˆ†å‘+1ï¼Œçµæ„Ÿ-2ï¼‰"; } }
            ]
        })
    },
    addNewEvent: function(eventObj) {
        this.eventPool.push(eventObj);
    },
        checkEvents: function(context) {
        // æ–°å¢ï¼šæ£€æŸ¥å¹´åº¦éšæœºäº‹ä»¶è§¦å‘æ¬¡æ•°æ˜¯å¦å·²è¾¾ä¸Šé™
        if (State.triggeredEventCount >= 3) {
            return false;
        }

        let candidates = this.eventPool.filter(e => {
        // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ å…¨å±€å”¯ä¸€æ€§æ£€æŸ¥ â–¼â–¼â–¼
        // å¦‚æœäº‹ä»¶æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå¹¶ä¸”å®ƒçš„IDå·²ç»å­˜åœ¨äºâ€œå…¨å±€æ¸…å•â€ä¸­...
        if (e.globalOneTime && State.triggeredGlobalEvents.includes(e.id)) {
            return false; // ...åˆ™ç›´æ¥æ’é™¤ï¼Œä¸å‚ä¸åç»­è§¦å‘åˆ¤å®šã€‚
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

        // å¦‚æœé€šè¿‡äº†å…¨å±€æ£€æŸ¥ï¼Œå†æ‰§è¡Œå®ƒè‡ªèº«çš„è§¦å‘æ¡ä»¶
        return e.trigger(State);
    });

    if (candidates.length > 0) {
        const idx = Math.floor(Math.random() * candidates.length);
        const evt = candidates[idx];
        if (Math.random() <= evt.probability) {
            // 3. è§¦å‘æˆåŠŸåï¼Œæ›´æ–°å¹´åº¦è®¡æ•°å™¨
            State.triggeredEventCount++;
            
            // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœè§¦å‘çš„æ˜¯å…¨å±€å”¯ä¸€äº‹ä»¶ï¼Œå°†å…¶IDè®¡å…¥â€œå…¨å±€æ¸…å•â€ â–¼â–¼â–¼
            if (evt.globalOneTime) {
                State.triggeredGlobalEvents.push(evt.id);
                UI.log(`(ä¸€ä¸ªç‹¬ç‰¹çš„äº‹ä»¶å‘ç”Ÿäº†ï¼Œè¿™å°†æˆä¸ºä½ èŒä¸šç”Ÿæ¶¯ä¸­å®è´µçš„å›å¿†ã€‚)`);
            }
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

            UI.showEventModal(evt);
            UI.log(`(æœ¬å¹´åº¦å·²è§¦å‘ ${State.triggeredEventCount} ä¸ªéšæœºäº‹ä»¶)`);
            return true;
            }
        }
        return false;
    }
};

/* ============================================================
   4. æ¸¸æˆé€»è¾‘æ ¸å¿ƒ
   ============================================================ */
const Game = {
  // æ–°å¢ï¼šä»é¦–é¡µæ­£å¼è¿›å…¥åºå¹•çš„é€»è¾‘
    startToPrologue: function() {
        UI.switchScreen('screen-prologue'); // åˆ‡æ¢åˆ°åºå¹•é¡µé¢
        this.renderPrologue();              // å¼€å§‹æ¸²æŸ“åºå¹•çš„é€‰æ‹©é¡¹
    },
  
  restartGame: function() {
        State = JSON.parse(JSON.stringify(InitialState));
        UI.switchScreen('screen-start');
        UI.renderPrologue();
    },

    choosePrologue: function(optionIndex) {
        const stepData = CONFIG.prologue[State.step];
        const opt = stepData.options[optionIndex];
        if(opt.res) State.resPoints += opt.res;
        if(opt.pow) State.pow += opt.pow;
        if(opt.art) State.art += opt.art;
        if(opt.bod) State.bod += opt.bod;
        if(opt.ins) State.ins += opt.ins;
        if (State.step === 0) State.origin = opt.txt;
        if (opt.isGen2) State.isGen2 = true;
        if (opt.traitId) State.trait = opt.traitId;
        State.step++;
        if (State.step < CONFIG.prologue.length) {
            UI.renderPrologue();
        } else {
            this.startChapter1();
        }
    },

    startChapter1: function() {
        UI.switchScreen('screen-chapter1');
        this.renderNode(1);
    },

    renderNode: function(nodeId) {
        let text = "";
        let options = [];
        if (nodeId === 1) {
            text = State.origin === "å†°é›ªé‡é•‡" ?
            "å¯’é£å‘¼å•¸ï¼Œä½ èµ°ä¸Šé‚£ç‰‡éœ²å¤©çš„é‡å†°åœºã€‚" : "å†°åœºå»ºåœ¨ç¹åçš„å•†åœºä¸­å¿ƒï¼Œä½ è¶´åœ¨æŠ¤æ ç»ç’ƒä¸Šï¼Œçœ‹ç€å†°é¢ä¸Šæ»‘è¡Œçš„äººå½±ã€‚";
            text += State.isGen2 ? "<br>ä½œä¸ºå†°äºŒä»£ï¼Œè¸ä¸Šå†°åœºå¯¹ä½ æ¥è¯´æ˜¯å†è‡ªç„¶ä¸è¿‡çš„äº‹ã€‚ä½ çœ‹ç€çœ¼å‰è¿™ç‰‡æ´ç™½çš„å†°é¢ï¼Œå¿ƒé‡Œæƒ³çš„æ˜¯ï¼š" : "<br>è¿™æ˜¯ä½ ç¬¬ä¸€æ¬¡æ¥åˆ°å†°åœºï¼Œå‘¨å›´å†·é£•é£•çš„ï¼Œä¸€åˆ‡éƒ½å¾ˆé™Œç”Ÿã€‚ä½ çœ‹ç€çœ¼å‰è¿™ç‰‡æ´ç™½çš„å†°é¢ï¼Œå¿ƒé‡Œæƒ³çš„æ˜¯ï¼š";
            options = [
                { txt: "åœ¨è¿™é‡Œè½¬åœˆè‚¯å®šå¾ˆå¥½çœ‹", action: ()=>{State.art+=2;
                this.renderNode(2);} },
                { txt: "æ„Ÿè§‰ä¼šæ‘”è·¤ï¼Œä½†æˆ‘å¾—è¯•è¯•", action: ()=>{State.ins+=1;
                State.bod+=1; this.renderNode(2);} },
                { txt: "æ»‘å¾—å¥½å¿«ï¼Œæˆ‘ä¹Ÿæƒ³å†²å¾—é‚£ä¹ˆå¿«ï¼", action: ()=>{State.pow+=2;
                this.renderNode(2);} }
            ];
        } else if (nodeId === 2) {
            text = "ä½ æ˜¯ä¸ªæ»‘å†°çš„å¥½è‹—å­ã€‚çˆ¶æ¯å•†é‡åä¸ºä½ æŠ¥äº†èŠ±æ»‘ç­ï¼Œä½ å¼€å§‹æ¥å—è§„å¾‹çš„è®­ç»ƒã€‚<br>æ¯æ¬¡ä¸‹è¯¾å‰çš„æœ€åååˆ†é’Ÿï¼Œæ˜¯æ•™ç»ƒç•™ç»™ä½ ä»¬çš„â€œè‡ªç”±æ—¶é—´â€ã€‚ä½ å–˜ç€æ°”ï¼Œçœ‹ç€è¿™ç‰‡å±äºä½ çš„å†°é¢ï¼Œä½ æœ€å–œæ¬¢åšçš„äº‹æƒ…æ˜¯ï¼š";
            options = [
                { txt: "å­¦ç€ç”µè§†é‡Œçš„æ ·å­ï¼Œè‡ªå·±çç¼–ä¸€ç‚¹åŠ¨ä½œã€‚", action: ()=>{State.art+=2;
                UI.showModal(" ", "æ¨¡ä»¿ç”µè§†é‡Œçš„è¿åŠ¨å‘˜ï¼Œä½ åˆç€èŠ‚æ‹æ»‘è¡Œã€‚è™½ç„¶åŠ¨ä½œè¿˜å¾ˆå¹¼ç¨šï¼Œä½†æ•™ç»ƒè¯´ä½ æœ‰ä¸€è‚¡éš¾å¾—çš„çµæ°”ã€‚", ()=>this.renderNode(3));} },
                { txt: "ç›¯ç€å†°é¢ä¸Šçš„åˆ’ç—•ï¼Œæƒ³æŠŠåˆšæ‰æ•™çš„åŠ¨ä½œç»ƒå¾—æ›´åƒæ ·ã€‚", action: ()=>{State.ins+=1;State.bod+=1;
                UI.showModal(" ", "ä½ æ˜¯ä¸ªè€å¾—ä½å¯‚å¯çš„å­©å­ã€‚å½“åˆ«äººåœ¨ç©é—¹æ—¶ï¼Œä½ å·²ç»èƒ½æ»‘å‡ºæ¯”ä»–ä»¬æ›´ç¨³çš„çº¿æ¡äº†ã€‚", ()=>this.renderNode(3));} },
                { txt: "å’Œå…¶ä»–å°æœ‹å‹èµ›è·‘ï¼Œçœ‹è°å…ˆå†²åˆ°å†°åœºé‚£ä¸€å¤´ã€‚", action: ()=>{State.pow+=2;
                UI.showModal(" ", "ä½ æ€»æ˜¯é¥é¥é¢†å…ˆï¼Œé€Ÿåº¦å¸¦èµ·çš„å†·é£è®©ä½ è§‰å¾—å¼‚å¸¸å…´å¥‹ã€‚", ()=>this.renderNode(3));} }
            ];
       }else if (nodeId === 3) {
    text = "ä½ å·²ç»ä¸Šå†°å¥½å‡ å¹´äº†ã€‚æ–°é²œæ„Ÿæ—©å·²æ¶ˆå¤±ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æ¯å¤©å‡ ç™¾æ¬¡çš„å‹åˆƒã€èµ·è·³å’Œæ‘”å€’ã€‚<br>åœ¨ä¸€ä¸ªå¯’å†·çš„æ—©æ™¨ï¼Œå¦ˆå¦ˆè¹²ä¸‹å¸®ä½ æ‹‰å¥½æŠ¤å…·ï¼Œé—®ä½ ï¼šâ€œè¦æ˜¯è§‰å¾—å¤ªç´¯äº†ï¼Œå’±ä»¬å°±ä¸ç»ƒäº†å§ï¼Ÿâ€";
    options = [
        { 
            txt: "æˆ‘è¦æ»‘ä¸‹å»", 
            action: () => {
                State.bod += 1;
                this.renderNode(4);
            } 
        },
        { 
            txt: "æˆ‘ä¸æƒ³ç»ƒäº†...", 
            action: (btn) => { 
                btn.style.display = 'none'; 
            }
        }
    ];
}else if (nodeId === 4) {
            text = "æ•™ç»ƒæŠŠä½ å•ç‹¬å«åˆ°åŠå…¬å®¤ï¼Œæ‰‹é‡Œæ‹¿ç€ä½ è¿™ä¸€å¹´çš„ä½“èƒ½æµ‹è¯•å’Œæ»‘è¡Œæ•°æ®ã€‚<br>â€œä½ çš„çˆ†å‘åŠ›å¾ˆå¼ºï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œä½†åœ¨åŠ¨ä½œçš„ç»†è…»ç¨‹åº¦ä¸Šç¨æ˜¾ä¸è¶³ã€‚â€æ•™ç»ƒçœ‹ç€ä½ è¯´ï¼Œâ€œå¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥æ¨èä½ å»éš”å£çš„çŸ­é“é€Ÿæ»‘é˜Ÿã€‚æˆ–è€…ï¼Œç»§ç»­ç•™åœ¨è¿™é‡Œã€‚";
            options = [
                { txt: "æˆ‘è¿˜æ˜¯æƒ³ç•™åœ¨è¿™é‡Œã€‚", action: ()=>{ this.startChapter2();
                } },
                { txt: "æˆ‘æƒ³çœ‹çœ‹ï¼Œæˆ‘åˆ°åº•èƒ½æ»‘å¤šå¿«ã€‚", action: ()=>{ UI.triggerEnding('wind');
                } }
            ];
        }
        UI.updateStory(text, options);
    },

    startChapter2: function() {
        State.chapter = 2;
        State.money = State.resPoints * 100;
        EventManager.init(); 
        UI.switchScreen('screen-dashboard');
        UI.initDashboard();
        UI.showModal("æç¤º", "è¿™æ˜¯ä½ è¿›å…¥é’å¹´ç»„çš„ç¬¬ä¸€å¹´ã€‚");
        UI.log("è¿›å…¥é’å¹´ç»„ï¼Œå¼€å¯èŒä¸šç”Ÿæ¶¯ã€‚");
    },

      // (è¿™æ˜¯ Game å¯¹è±¡å†…éƒ¨ï¼Œä¾‹å¦‚æ”¾åœ¨ startChapter2 å‡½æ•°ä¸‹é¢)

    // =================================================================
    // ã€æ–°å¢ã€‘è”ç³»äººäº‹ä»¶ - å¹´åº¦æŠ½å–é€»è¾‘
    // =================================================================
    rollForContactEvents: function() {
        State.activeContactEvents = [];
        const triggeredContacts = [];

        // ä¸ºäº†è®©â€œæœ€å¤š3ä¸ªâ€çš„ç­›é€‰æ›´å…¬å¹³ï¼Œå…ˆå°†æ‰€æœ‰è”ç³»äººéšæœºæ’åº
        const contactKeys = Object.keys(CONTACT_EVENTS);
        for (let i = contactKeys.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [contactKeys[i], contactKeys[j]] = [contactKeys[j], contactKeys[i]];
        }
        
        // æ ¹æ®å„è‡ªçš„æ¦‚ç‡è¿›è¡Œâ€œè¿‡æ£€â€
        for (const key of contactKeys) {
            const contact = CONTACT_EVENTS[key];
            if (Math.random() < contact.probability) {
                triggeredContacts.push(contact);
            }
        }

        // æœ€å¤šåªå–3ä¸ªè¢«è§¦å‘çš„è”ç³»äºº
        const finalContacts = triggeredContacts.slice(0, 3);

        let logMsg = "æ–°å¹´æ–°æ°”è±¡ï¼Œ";
        if (finalContacts.length > 0) {
            const names = [];
            finalContacts.forEach(contact => {
                const availableEvents = contact.events;
                if (availableEvents.length > 0) {
                    // ä»è¯¥è”ç³»äººçš„äº‹ä»¶æ± ä¸­ï¼ŒéšæœºæŠ½å–ä¸€ä¸ªä½œä¸ºæœ¬å¹´åº¦çš„å”¯ä¸€äº‹ä»¶
                    const chosenEvent = availableEvents[Math.floor(Math.random() * availableEvents.length)];
                    State.activeContactEvents.push({
                        contactId: contact.id,
                        event: chosenEvent
                    });
                    names.push(contact.name);
                }
            });
            if (names.length > 0) {
                 logMsg += `ä½ æ”¶åˆ°äº†æ¥è‡ª [${names.join(']ã€[')}] çš„æ–°æ¶ˆæ¯ã€‚`;
                 UI.log(logMsg);
            }
        }
    },
      
      // (åœ¨ Game å¯¹è±¡å†…éƒ¨ï¼Œä¾‹å¦‚ rollForContactEvents å‡½æ•°çš„ä¸‹æ–¹)

    // =================================================================
    // ã€æ–°å¢ã€‘è”ç³»äººäº‹ä»¶ - è‡ªåŠ¨æ£€æŸ¥ä¸è§¦å‘é€»è¾‘
    // =================================================================
        // =================================================================
    // ã€ä¿®æ”¹ã€‘è”ç³»äººäº‹ä»¶ - è‡ªåŠ¨æ£€æŸ¥ä¸è§¦å‘é€»è¾‘ (V2.0)
    // =================================================================
    checkContactEvents: function() {
        // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæ»¡è¶³å½“å‰è§¦å‘æ¡ä»¶çš„è”ç³»äººäº‹ä»¶
        const eventIndex = State.activeContactEvents.findIndex(e => e.event.trigger(State));

        if (eventIndex === -1) {
            return false; // æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è”ç³»äººäº‹ä»¶
        }

        const activeEvent = State.activeContactEvents[eventIndex];
        const eventData = activeEvent.event;

        // 1. HP é¢„æ£€æŸ¥ (åªæ£€æŸ¥ï¼Œä¸æ‰£è´¹)ï¼ŒHPä¸è¶³åˆ™é™é»˜å¤±è´¥
        if (eventData.cost && State.hp <= eventData.cost) {
            UI.log(`(å› ä¸ºHPä¸è¶³ï¼Œé”™è¿‡äº†äº‹ä»¶ï¼š${eventData.name})`);
            return false;
        }

        // 2. å‡†å¤‡å¼¹çª—æ•°æ®
        const modalData = {
            title: eventData.name, // è¯·æ±‚2ï¼šä½¿ç”¨äº‹ä»¶åä½œä¸ºæ ‡é¢˜
            text: eventData.text || eventData.return, // ä½¿ç”¨æè¿°æˆ–è¿”å›æ–‡æœ¬
            options: []
        };

        // 3. è¿™æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œç”¨äºåŒ…è£…â€œç¡®è®¤â€æ“ä½œ
        // å®ƒè´Ÿè´£ï¼šæ‰£è´¹ã€æ‰§è¡Œæ•ˆæœã€ä»Stateä¸­ç§»é™¤äº‹ä»¶
        const createConfirmWrapper = (originalEffect) => {
            return (s) => {
                // åœ¨æ‰§è¡Œå‰å†æ¬¡æ£€æŸ¥HPï¼Œä»¥é˜²ä¸‡ä¸€
                if (eventData.cost && s.hp < eventData.cost) {
                    return "è¡ŒåŠ¨å¤±è´¥ï¼Œä½ çš„HPä¸è¶³ï¼";
                }
                // æ‰£è´¹
                if (eventData.cost) {
                    s.hp -= eventData.cost;
                }

                // æ‰§è¡ŒåŸå§‹æ•ˆæœ
                const feedback = originalEffect(s);

                // ä»Stateä¸­ç§»é™¤äº‹ä»¶
                const indexToRemove = State.activeContactEvents.findIndex(e => e.event.name === eventData.name);
                if (indexToRemove > -1) {
                    State.activeContactEvents.splice(indexToRemove, 1);
                }
                return feedback;
            };
        };

        // 4. æ ¹æ®äº‹ä»¶ç±»å‹ç”Ÿæˆä¸åŒæŒ‰é’®
        if (eventData.options) { 
            // æƒ…å†µAï¼šäº‹ä»¶æœ¬èº«æœ‰å¤šä¸ªè‡ªå®šä¹‰é€‰é¡¹ (å¦‚â€œèµ›å‰èŠå¤©â€)
            modalData.options = eventData.options.map(opt => ({
                label: opt.label,
                effect: createConfirmWrapper(opt.effect) // æ¯ä¸ªé€‰é¡¹éƒ½æ˜¯ä¸€ä¸ªâ€œç¡®è®¤â€æ“ä½œ
            }));
        } else { 
            // æƒ…å†µBï¼šç®€å•äº‹ä»¶ï¼Œä¸ºå…¶ç”Ÿæˆâ€œç¡®å®šâ€å’Œâ€œç®—äº†â€
            
            // â€œç¡®å®šâ€æŒ‰é’®çš„æ•ˆæœ
            const onConfirmEffect = (s) => {
                let feedback = eventData.return || "äº‹ä»¶å·²å®Œæˆã€‚";
                if (eventData.effect) {
                    const effectReturn = eventData.effect(s);
                    if (typeof effectReturn === 'string') feedback = effectReturn;
                }
                return feedback;
            };
            
            // æ·»åŠ â€œç¡®å®šâ€æŒ‰é’®
            modalData.options.push({
                label: "ç¡®å®š",
                effect: createConfirmWrapper(onConfirmEffect)
            });

            // æ·»åŠ â€œç®—äº†ï¼Œä¸å¿…äº†â€æŒ‰é’®
            modalData.options.push({
                label: "ç®—äº†ï¼Œä¸å¿…äº†",
                effect: () => {
                   // â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ï¼šä»Stateä¸­ç§»é™¤æ­¤äº‹ä»¶ï¼Œå®ç°â€œå¹´åº¦å†…ä¸å†å¼¹å‡ºâ€ â–¼â–¼â–¼
        const indexToRemove = State.activeContactEvents.findIndex(e => e.event.name === eventData.name);
        if (indexToRemove > -1) {
            State.activeContactEvents.splice(indexToRemove, 1);
        }
        // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
        return "ä½ å†³å®šæš‚æ—¶ä¸æ‰“æ‰°å¯¹æ–¹ã€‚";
                }
            });
        }

        UI.showEventModal(modalData); // æ˜¾ç¤ºäº‹ä»¶å¼¹çª—
        return true; // æŠ¥å‘Šï¼šå·²æˆåŠŸè§¦å‘ä¸€ä¸ªäº‹ä»¶
    },

    // =================================================================
    // ã€æ–°å¢ã€‘ä¸»äº‹ä»¶æ£€æŸ¥å®˜
    // =================================================================
    masterEventCheck: function() {
        // ä¼˜å…ˆæ£€æŸ¥è”ç³»äººäº‹ä»¶
        const contactEventTriggered = this.checkContactEvents();
        
        // å¦‚æœè”ç³»äººäº‹ä»¶å·²ç»è§¦å‘ï¼Œåˆ™æœ¬æ¬¡ä¸å†æ£€æŸ¥éšæœºäº‹ä»¶æ± ï¼Œé¿å…å¼¹çª—è½°ç‚¸
        if (contactEventTriggered) {
            return;
        }
        
        // å¦‚æœæ²¡æœ‰è”ç³»äººäº‹ä»¶ï¼Œå†æ£€æŸ¥éšæœºäº‹ä»¶æ± 
        EventManager.checkEvents();
    },
  
 handleTraining: function() {
        const typeId = State.selectedTrainingId;
        
        // 1. å¦‚æœæ²¡æœ‰é€‰æ‹©è®­ç»ƒé¡¹ç›®ï¼Œæç¤ºé€‰æ‹©
        if (!typeId) {
            UI.showModal("æç¤º", "è¯·é€‰æ‹©è®­ç»ƒé¡¹ç›®ï¼");
            return;
        }

        /*
           ã€é€»è¾‘è¯´æ˜ã€‘ï¼š
           å¿…é¡»æŠŠâ€œä¼‘æ¯ (rest)â€çš„åˆ¤æ–­æ”¾åœ¨æ£€æŸ¥è¡€é‡ä¹‹å‰ã€‚
           è¿™æ ·å°±ç®— HP=10ï¼Œåªè¦é€‰çš„æ˜¯restï¼Œå°±èƒ½é€šè¿‡ä¸‹é¢çš„ ifï¼Œæ‰§è¡Œå›è¡€ã€‚
        */

        // 2. å¦‚æœé€‰æ‹©äº†å½»åº•ä¼‘æ¯ï¼Œå…è®¸æ‰§è¡Œï¼Œæ— è®ºè¡€é‡å¤šå°‘
        if (typeId === 'rest') {
            if (State.actionsLeft <= 0) return;
             State.restsThisSeason++; // æ–°å¢ï¼šèµ›å­£ä¼‘æ¯æ¬¡æ•°+1
          State.totalRestsAllTime++; // æ–°å¢ï¼šå…¨å±€ä¼‘æ¯æ¬¡æ•°+1
           
          // --- æ‰§è¡Œä¼‘æ¯é€»è¾‘ ---
            State.hp += 15;
            let maxHp = 100 - State.hpCapMalus;
            if (State.hp > maxHp) State.hp = maxHp;
            State.actionsLeft--;
            
            UI.log(`å½»åº•ä¼‘æ¯ (æ¢å¤)ï¼ŒHP+15`);
            UI.updateDashboard();
            this.checkGameOver(); // æ¯æ¬¡æ“ä½œåæ£€æŸ¥çŠ¶æ€
            return; // ä¼‘æ¯å®Œç›´æ¥ç»“æŸå‡½æ•°ï¼Œä¸å¾€ä¸‹èµ°äº†
        }

        // 3. å¦‚æœé€‰çš„ä¸æ˜¯ä¼‘æ¯ï¼Œç°åœ¨æ‰å¼€å§‹æ£€æŸ¥æ˜¯ä¸æ˜¯æ®‹è¡€
        /*
           ã€ä¿®æ”¹å‰ã€‘ï¼šåªæ˜¯ç®€å•çš„ returnï¼Œç©å®¶ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆã€‚
           ã€ä¿®æ”¹åã€‘ï¼šå¢åŠ ä¸€ä¸ªå¼¹çª—æç¤ºï¼Œå‘Šè¯‰ç©å®¶ä¸ºä»€ä¹ˆç‚¹ä¸äº†ã€‚
        */
        if (State.hp <= 29) {
            UI.showModal("è­¦å‘Š", "å¥åº·å€¼è¿‡ä½ï¼Œæ•™ç»ƒå‹’ä»¤ä½ ä¼‘æ¯ï¼(è¯·é€‰æ‹©â€œå½»åº•ä¼‘æ¯â€é¡¹ç›®)");
            return; // æ‹¦æˆªæ‰€æœ‰éä¼‘æ¯çš„è®­ç»ƒ
        }
        if (State.actionsLeft <= 0) return;
        const trainConf = CONFIG.trainings.find(t => t.id === typeId);
        
        let hpChange = 0;
        let intensityMult = 1.0;
        let intensityLog = "";
        if (typeId === 'rest') {
            hpChange = 15;
            intensityLog = "ä¼‘æ¯";
        } else {
          State.trainsThisSeason++; // æ–°å¢ï¼šèµ›å­£è®­ç»ƒæ¬¡æ•°+1 
          if (State.selectedIntensity === 'recover') { intensityMult = 0.5;
            hpChange = 5; intensityLog = "æ¢å¤"; }
            else if (State.selectedIntensity === 'normal') { intensityMult = 1.0;
            hpChange = -10; intensityLog = "å¸¸è§„"; }
            else if (State.selectedIntensity === 'sprint') { intensityMult = 1.2;
            hpChange = -15; intensityLog = "å†²åˆº"; }
            
            const injury = this.checkInjury(State.hp);
            if (injury !== 'none') {
                 this.handleInjury(injury);
                 if (injury === 'heavy' || injury === 'career') {
                     State.actionsLeft--;
                     UI.updateDashboard();
                     return; 
                 }
            }
        }

        let ageDecay = 1.0;
        if (State.group === 'adult') {
            const adultYear = State.year - 4;
            ageDecay = Math.max(0.6, 1.0 - (adultYear * 0.05));
        }

        let gainLog = [];
        if (typeId !== 'rest') {
            const getDiminishing = (val) => {
                if (val < 60) return 1.0;
                if (val < 85) return 0.75;
                return 0.4;
            };
          // ã€æ–°å¢ã€‘å¿ƒæ€å¯¹è®­ç»ƒçš„ä¿®æ­£
        let psycheTrainMult = 1.0;
        if (State.psyche < 10) psycheTrainMult = 0.8;       // å´©æºƒ
        else if (State.psyche < 30) psycheTrainMult = 0.9;  // ç„¦è™‘
        else if (State.psyche < 70) psycheTrainMult = 1.0;  // å¹³å’Œ
        else if (State.psyche < 90) psycheTrainMult = 1.1;  // è‡ªä¿¡
        else psycheTrainMult = 1.2;
          
            const traits = CONFIG.traitMultipliers[State.trait];
            const campBonus = State.modifiers.camp ?
            1.2 : 1.0;
            const skatesBonus = State.modifiers.skates ? 1.1 : 1.0;
             for (let stat in trainConf.gain) {
                let base = trainConf.gain[stat];
                let currentVal = State[stat];
                let dim = getDiminishing(currentVal);
                let tMult = traits[stat] || 1.0;
                let sMult = (stat === 'ins') ? skatesBonus : 1.0;
                let finalGain = base * intensityMult * dim * tMult * campBonus * sMult * ageDecay * psycheTrainMult;
               State[stat] = Math.min(100, State[stat] + finalGain);
            gainLog.push(`${stat.toUpperCase()} +${finalGain.toFixed(1)}`);
            }
        }

        State.hp += hpChange;
        let maxHp = 100 - State.hpCapMalus;
        if (State.hp > maxHp) State.hp = maxHp;
        if (State.modifiers.shield && typeId !== 'rest') {
            State.modifiers.shield = false;
            UI.log("é«˜çº§æŠ¤å…·å·²æ¶ˆè€—ã€‚");
        }

        State.actionsLeft--;
        let logStr = `[Y${State.year}] ${trainConf.name}(${intensityLog})`;
        if (gainLog.length > 0) logStr += `ï¼Œ${gainLog.join(', ')}`;
        if (ageDecay < 1.0) logStr += ` (å¹´é¾„è¡°å‡:${((1-ageDecay)*100).toFixed(0)}%)`;
        logStr += `ï¼ŒHP ${hpChange>0?'+':''}${hpChange}`;
        UI.log(logStr);

       this.masterEventCheck();
        UI.updateDashboard();
    },
// ã€æ–°å¢ã€‘å¤±è´¥æ¡ä»¶æ£€æŸ¥é€»è¾‘
    checkGameOver: function() {
        // 1. ç ´äº§ç»“å±€
        if (State.money < 0) {
            UI.triggerEnding('bankrupt');
            return;
        }
        
        // 2. ä¼¤ç—…å¼ºåˆ¶é€€å½¹ç»“å±€
        if (State.hp < 0) {
            UI.triggerEnding('hp_zero');
            return;
        }
      
        // 3. ç»å¢ƒç»“å±€æ£€æµ‹ (å†…å¤–äº¤å›°)
        // æ¡ä»¶ï¼šHP <= 29 (æ— æ³•è®­ç»ƒ) ä¸” æ— æ³•è´­ä¹°å›è¡€é“å…·
        if (State.hp <= 29 && State.actionsLeft > 0) {
            // æ£€æŸ¥æœ€ä¾¿å®œçš„å›è¡€é“å…· (èœ‚èœœæ°´ 80å…ƒ)
            const honeyCost = 80;
            const massageCost = 800;
            const honeyLimit = 3;
            const honeyUsed = State.shopLimits['honey'] || 0;
            
            // è¿˜æœ‰è®­ç»ƒæ¬¡æ•°ï¼Œä½†æ˜¯ä¸èƒ½è®­ç»ƒ
            // æ£€æŸ¥æ˜¯å¦èƒ½ä¹°èœ‚èœœæ°´ï¼šé’±å¤Ÿ ä¸” æ²¡é™è´­
            const canBuyHoney = (State.money >= honeyCost) && (honeyUsed < honeyLimit);
            // æ£€æŸ¥æ˜¯å¦èƒ½ä¹°ç­‹è†œæªï¼šé’±å¤Ÿ
            const canBuyMassage = (State.money >= massageCost);

            // å¦‚æœéƒ½ä¹°ä¸èµ·ï¼ˆæˆ–æ²¡æ¬¡æ•°ï¼‰ï¼Œä¸”å¿…é¡»å›è¡€æ‰èƒ½ç»§ç»­è®­ç»ƒ
            // æ³¨æ„ï¼šå› ä¸ºç°åœ¨å¼€æ”¾äº†â€œå½»åº•ä¼‘æ¯â€ï¼Œç†è®ºä¸Šåªè¦æœ‰æ¬¡æ•°å°±èƒ½ä¼‘æ¯å›è¡€ï¼Œæ­»å±€å¾ˆéš¾å‘ç”Ÿã€‚
            // ä½†å¦‚æœç­–åˆ’è¦æ±‚åŠ å…¥æ­¤åˆ¤å®šï¼Œæˆ‘ä»¬å‡è®¾â€œè¿å½»åº•ä¼‘æ¯éƒ½æ— æ³•æŒ½å›â€æˆ–è€…é€»è¾‘ä¸Šä¾ç„¶éœ€è¦é’±ç»´æŒã€‚
            // æŒ‰ç…§éœ€æ±‚æè¿°ï¼šâ€œé‡‘é’±ä¸è¶³è´­ä¹°ä¸”æ¬¡æ•°ç”¨å®Œ...â€ï¼Œæˆ‘ä»¬æ·»åŠ æ­¤åˆ¤å®šã€‚
            if (!canBuyHoney && !canBuyMassage) {
                // è¿™é‡ŒåŠ ä¸€ä¸ªä¿é™©ï¼šå¦‚æœHPæä½ä¸”æ²¡é’±ï¼Œè™½ç„¶å¯ä»¥ä¼‘æ¯ï¼Œä½†å¦‚æœä¼‘æ¯ä¹ŸåŠ ä¸æ»¡30ï¼ˆæ¯”å¦‚HP=10, ä¼‘æ¯+15=25 ä¾ç„¶æ— æ³•è®­ç»ƒï¼‰ï¼Œ
                // ä¸”æ¬¡æ•°åªå‰©1æ¬¡ï¼Œé‚£ä¸‹å›åˆè¿˜æ˜¯åŠ¨ä¸äº†ã€‚è¿™ç§å°±æ˜¯æ­»å±€ã€‚
                if ((State.hp + 15) <= 29 && State.actionsLeft <= 1) {
                     UI.triggerEnding('despair');
                }
            }
        }
    },
    checkInjury: function(hp) {
        if (State.injuryImmunity) return 'none'; 
        if (State.modifiers.shield) return 'none';
        let prob = 0.01;
      
        if (hp >= 70) prob = 0.01;
        else if (hp >= 50) prob = 0.05;
        else if (hp >= 30) prob = 0.10;
        if (State.group === 'youth') prob = Math.max(0, prob - 0.02);
        if (State.group === 'adult' && State.year >= 9) prob += (State.year - 8) * 0.01;
       // ã€æ–°å¢ã€‘å¿ƒæ€å¯¹å—ä¼¤ç‡çš„å½±å“
        if (State.psyche >= 70 && State.psyche < 90) prob += 0.05; // è‡ªä¿¡ +5%
        if (State.psyche >= 90) prob += 0.10; // ç‹‚çƒ­ +10%
      
        if (Math.random() < prob) {
            const roll = Math.random();
            if (roll < 0.01 && hp < 50) return 'career';
            if (roll < 0.20 && hp < 70) return 'heavy';
            return 'light';
        }
        return 'none';
    },

   handleInjury: function(type) {
        if (type === 'light') {
            State.hp -= 10;
            this.updatePsyche(-5); // ã€æ–°å¢ã€‘è½»ä¼¤æ‰£å¿ƒæ€
            UI.log("âš  æ„å¤–è½»ä¼¤ï¼HP -10ï¼Œå¿ƒæ€ -5");
            UI.showModal("å—ä¼¤", "è®­ç»ƒä¸­æ„å¤–å—äº†è½»ä¼¤ã€‚");
        } else if (type === 'heavy') {
            State.hp -= 20;
            State.hpCapMalus += 10;
            State.heavyInjuryCount++;
            this.updatePsyche(-10); // ã€æ–°å¢ã€‘é‡ä¼¤æ‰£å¿ƒæ€
            UI.log("âš âš  é­é‡é‡ä¼¤ï¼HPä¸Šé™ -10ï¼Œå¿ƒæ€ -10");
            UI.showModal("é‡ä¼¤", "é­é‡é‡ä¼¤ï¼åŒ»ç”Ÿè¯´ä½ çš„èº«ä½“æœºèƒ½æ°¸ä¹…ä¸‹é™äº†ã€‚");
        } else if (type === 'career') {
          this.updatePsyche(-15);
            if (Math.random() < 0.25) {
                UI.triggerEnding('injury');
            } else {
           UI.log("âš âš âš  æé‡ä¼¤ï¼è¢«è¿«ä¼‘èµ›ä¸€å¹´ï¼ï¼ˆå¿ƒæ€-15ï¼‰ ");
                UI.showModal("æé‡ä¼¤", "æé‡ä¼¤ï¼æœ¬èµ›å­£æŠ¥é”€ã€‚");
                State.actionsLeft = 0;
            }
        }
    },

        // =================================================================
    // ã€ä¿®æ”¹ã€‘æ¨è¿›é˜¶æ®µé€»è¾‘ (æ”¹ä¸ºæ‰‹åŠ¨ç»“ç®—åˆ¶)
    // =================================================================
    advancePhase: function() {
        // --- æƒ…å†µAï¼šä¼‘èµ›æœŸï¼Œç‚¹å‡»è¿›å…¥é€‰æ‹”èµ› ---
        if (State.phase === 'offseason') {
            const isAdult = State.group === 'adult';
            const qualifyName = "å›½å†…é€‰æ‹”èµ›"; 
            
            // è®¡ç®—é€‰æ‹”èµ›åˆ†æ•°
            const result = this.calculateScores();
            
            // è®¡ç®—æ’å
            const npcConfig = isAdult ? CONFIG.matchConfig.adult.qualify : CONFIG.matchConfig.youth.qualify;
            let rank = 1;
            for(let i=0; i<15; i++) {
                let npc = npcConfig.base + (Math.random() * npcConfig.range);
                if(npc > result.total) rank++;
            }

            const threshold = isAdult ? 8 : 5;
            const qualified = rank <= threshold;
            
            // æ„å»ºæˆ˜æŠ¥æ–‡æœ¬
            let msg = `åœ¨${qualifyName}ä¸­ï¼Œä½ æ’åç¬¬ ${rank}ï¼Œæ€»åˆ† ${result.total.toFixed(2)} (SP:${result.sp.toFixed(2)} FS:${result.fs.toFixed(2)})ã€‚`;
            State.currentSeasonMatches = [];
            State.gpRankings = []; 

            if (qualified) {
                State.seasonQualified = true;
                msg += "<br><br>æˆåŠŸå…¥é€‰å›½é™…èµ›åå•ï¼<br>æœ¬èµ›å­£èµ›ç¨‹ï¼š";
                
                let countries = [...CONFIG.countries]; 
                let s1 = countries.splice(Math.floor(Math.random() * countries.length), 1)[0];
                let s2 = countries.splice(Math.floor(Math.random() * countries.length), 1)[0];
                let prefix = isAdult ? "GP" : "JGP";
                State.currentSeasonMatches.push(`${prefix} ${s1}ç«™`);
                State.currentSeasonMatches.push(`${prefix} ${s2}ç«™`);
                msg += `${prefix}ä¸¤ç«™ -> `;

                if (isAdult) {
                    State.currentSeasonMatches.push("å…¨é”¦èµ›", "å››å¤§æ´²é”¦æ ‡èµ›");
                    msg += "å…¨é”¦èµ› -> å››å¤§æ´² -> ";
                    if (State.year === 7 || State.year === 11) {
                        State.currentSeasonMatches.push("äºšå†¬ä¼š");
                        msg += "äºšå†¬ä¼š -> ";
                    }
                    if ((State.year === 8 || State.year === 12) && rank === 1 && State.fame > 800) {
                        State.currentSeasonMatches.push("å†¬å¥¥ä¼š");
                        msg += "[å†¬å¥¥ä¼š] -> ";
                    }
                    State.currentSeasonMatches.push("ä¸–é”¦èµ›");
                    msg += "ä¸–é”¦èµ›";
                } else {
                    State.currentSeasonMatches.push("å…¨é’èµ›");
                    msg += "å…¨é’èµ› -> ";
                    if (State.year === 4) {
                        State.currentSeasonMatches.push("é’å†¬å¥¥");
                        msg += "é’å†¬å¥¥ -> ";
                    }
                    State.currentSeasonMatches.push("ä¸–é’èµ›");
                    msg += "ä¸–é’èµ›";
                }
            } else {
                // è½é€‰é€»è¾‘ (å«å¹¸è¿é€’è¡¥)
                State.seasonQualified = false;
                if (rank > threshold && rank <= threshold + 3 && Math.random() < 0.2) {
                    State.seasonQualified = true;
                    State.luckyFish = true;
                    msg += "<br><br>ä½†æ˜¯ï¼åŸå®šé€‰æ‰‹å› ä¼¤é€€èµ›ï¼Œä½ ä½œä¸ºç¬¬ä¸€å€™è¡¥è¢«ç´§æ€¥å¾å¬ï¼";
                    let countries = [...CONFIG.countries];
                    let s1 = countries[Math.floor(Math.random() * countries.length)];
                    let prefix = isAdult ? "GP" : "JGP";
                    State.currentSeasonMatches = [`${prefix} ${s1}ç«™`];
                    if(isAdult) State.currentSeasonMatches.push("å…¨é”¦èµ›", "å››å¤§æ´²é”¦æ ‡èµ›", "ä¸–é”¦èµ›");
                    else State.currentSeasonMatches.push("å…¨é’èµ›", "ä¸–é’èµ›");
                } else {
                    if (isAdult) State.currentSeasonMatches = ["å…¨é”¦èµ›"];
                    else State.currentSeasonMatches = ["å…¨é’èµ›"];
                    msg += `<br><br>æœªèƒ½è·å¾—å›½é™…èµ›åé¢ã€‚æœ¬èµ›å­£ä»…å‚åŠ ${isAdult?"å…¨é”¦èµ›":"å…¨é’èµ›"}ã€‚`;
                }
            }

            let fatigue = Math.floor(Math.random() * 6) + 5;
            State.hp -= fatigue;
            msg += `<br>(æ¯”èµ›æ¶ˆè€— HP -${fatigue})`;

            // æ˜¾ç¤ºç»“æœå¹¶è¿›å…¥èµ›å­£
            UI.showModal("é€‰æ‹”èµ›ç»“æœ", msg, () => {
                State.phase = 'season';
                State.actionsLeft = 2; 
                let maxHp = 100 - State.hpCapMalus;
                State.hp = Math.min(maxHp, State.hp + 20);
                UI.log(`é€‰æ‹”èµ›ç»“æŸï¼Œè¿›å…¥èµ›å­£ã€‚`);
                UI.updateDashboard();
            });

        } else {
            // --- æƒ…å†µBï¼šèµ›å­£ä¸­ ---
            
            if (State.currentSeasonMatches.length > 0) {
                // B1: è¿˜æœ‰æ¯”èµ›ï¼Œå»æ‰“æ¯”èµ›
                this.runNextMatch();
            } else {
                // B2: æ²¡æ¯”èµ›äº†ï¼Œè¯´æ˜ç©å®¶ç‚¹å‡»çš„æ˜¯"èµ›å­£ç»“æŸ"æŒ‰é’®
                // 1. ç”Ÿæˆæ€»ç»“æŠ¥å‘ŠHTMLå­—ç¬¦ä¸²
            let summary = `<h3 style="text-align:center;">æœ¬èµ›å­£æ€»ç»“</h3><ul style="text-align:left; list-style-position: inside; padding-left:0;">`;
            summary += `<li>å›½é™…èµ›èµ„æ ¼ï¼š${State.seasonQualified ? `æ˜¯ ${State.luckyFish ? '(<span style=\\"color:#e17055;\\">å¹¸è¿é€’è¡¥</span>)' : ''}` : 'å¦'}</li>`;
            summary += `<li>æ€»å†³èµ›èµ„æ ¼ï¼š${State.qualifiedForGPFinalThisSeason ? '<span style=\\"color:#00b894;\\">æ˜¯</span>' : 'å¦'}</li>`;
            summary += `<hr style="border:none; border-top:1px dashed #ccc; margin: 8px 0;">`;
            summary += `<li>è®­ç»ƒæ¬¡æ•°ï¼š${State.trainsThisSeason}</li>`;
            summary += `<li>ä¼‘æ¯æ¬¡æ•°ï¼š${State.restsThisSeason}</li>`;
            summary += `<li>è®­ç»ƒå—ä¼¤ï¼š${State.injuriesThisSeason > 0 ? `<span style=\\"color:#d63031;\\">${State.injuriesThisSeason}æ¬¡</span>` : 'æ— '}</li>`;
            summary += `<hr style="border:none; border-top:1px dashed #ccc; margin: 8px 0;">`;
            summary += `<li>è·å¾—å¥–ç‰Œï¼šğŸ¥‡${State.medalsThisSeason.G} ğŸ¥ˆ${State.medalsThisSeason.S} ğŸ¥‰${State.medalsThisSeason.B}</li>`;
            summary += `</ul><br>`;

            // 2. ç»„åˆæœ€ç»ˆçš„å¼¹çª—ä¿¡æ¯
            const message = summary + "æœ¬èµ›å­£æ‰€æœ‰èµ›äº‹å·²åœ†æ»¡ç»“æŸï¼Œå³å°†è¿›å…¥ä¼‘èµ›æœŸã€‚";

            // 3. æ˜¾ç¤ºå¸¦æœ‰æ€»ç»“çš„å¼¹çª—
            UI.showModal( "èµ›å­£ç»“æŸ",message, () => {
                 this.endSeason();
                });
            }
        }
    },


     // =================================================================
    // ã€é‡æ„ã€‘æ¯”èµ›å¾—åˆ†è®¡ç®—æ¡†æ¶
    // =================================================================
        calculateScores: function(env = null) {
        // 1. åŸºç¡€é…ç½® (ä¸å˜)
        const baseScores = { sp: 26.25, fs: 42.5 };
        const baseWeights = {
            sp: { pow: 0.28, art: 0.28, ins: 0.10, bod: 0.0275 },
            fs: { pow: 0.30, art: 0.30, ins: 0.50, bod: 0.525 }
        };
        let finalWeights = JSON.parse(JSON.stringify(baseWeights));

        // 2. ç¯å¢ƒä¿®æ­£ (ä¸å˜)
        if (env && env.effect) {
            for (const key in env.effect) {
                if (key.startsWith('sp_') || key.startsWith('fs_')) {
                    const [program, stat] = key.split('_');
                    if(finalWeights[program] && finalWeights[program][stat] !== undefined) {
                        finalWeights[program][stat] += env.effect[key];
                    }
                }
            }
        }

        // 3. å±æ€§åˆ†è®¡ç®— (ä¸å˜)
        const spAttrScore = State.pow * finalWeights.sp.pow + State.art * finalWeights.sp.art + State.ins * finalWeights.sp.ins + State.bod * finalWeights.sp.bod;
        const fsAttrScore = State.pow * finalWeights.fs.pow + State.art * finalWeights.fs.art + State.ins * finalWeights.fs.ins + State.bod * finalWeights.fs.bod;

        // 4. HPä¿®æ­£ (ä¸å˜)
        let hpModifier = 0.8 + (State.hp / 500);
        if (env && env.effect && env.effect.isSpecial === 'altitude_hp_effect') {
            hpModifier = 0.8 + (State.hp / 600);
        }

        // 5. ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¿ƒæ€ä¿®æ­£ä¸éšæœºç³»æ•°
        let psycheScoreMult = 1.0;
        let randomModifier = 1.0;

        // åˆ¤æ–­å¿ƒæ€åŒºé—´
        if (State.psyche < 10) { // å´©æºƒ
            psycheScoreMult = 0.9;
        } else if (State.psyche < 30) { // ç„¦è™‘
            psycheScoreMult = 0.95;
        } else if (State.psyche < 70) { // å¹³å’Œ
            psycheScoreMult = 1.0;
        } else if (State.psyche < 90) { // è‡ªä¿¡
            psycheScoreMult = 1.05;
        } else { // ç‹‚çƒ­ (90-100)
            psycheScoreMult = 1.1; // è¡¥å……äº†1.1å€ç‡
        }

        if (State.psyche >= 90) {
            // ã€ç‹‚çƒ­çŠ¶æ€ã€‘ï¼šæ— è§†çµæ„Ÿï¼Œå¼ºåˆ¶æœ€å¤§æ³¢åŠ¨ (0.9 ~ 1.1)
            // é€»è¾‘ï¼šåŸºç¡€ 1.0 + (-0.1 åˆ° +0.1)
            randomModifier = 0.9 + Math.random() * 0.2;
        } else {
            // ã€æ™®é€šçŠ¶æ€ã€‘ï¼šå—çµæ„Ÿå½±å“ç¨³å®šæ€§
            const stability = (State.bod + State.ins) / 200;
            const reducedWidth = 0.2 * (1 - stability * 0.75);
            randomModifier = (1 - reducedWidth / 2) + Math.random() * reducedWidth;
        }

        // 6. æœ€ç»ˆè®¡ç®—
        let spFinal = (baseScores.sp + spAttrScore) * hpModifier * randomModifier * psycheScoreMult;
        let fsFinal = (baseScores.fs + fsAttrScore) * hpModifier * randomModifier * psycheScoreMult;
        
        // ç¯å¢ƒé¢å¤–åŠ åˆ† (ä¸å˜)
        if (env && env.effect && env.effect.score_bonus) {
            spFinal += env.effect.score_bonus * 0.3;
            fsFinal += env.effect.score_bonus * 0.7;
        }

        return {
            sp: spFinal,
            fs: fsFinal,
            total: spFinal + fsFinal
        };
    },

        // =================================================================
    // ã€ä¿®æ”¹ã€‘æ‰§è¡Œä¸‹ä¸€åœºæ¯”èµ› (ä¿®å¤äº†è·³è¿‡é—®é¢˜)
    // =================================================================
    runNextMatch: function() {
        // å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢ç©ºæ•°ç»„æŠ¥é”™
        if (State.currentSeasonMatches.length === 0) {
            UI.updateDashboard();
            return;
        }

        // å–å‡ºä¸‹ä¸€åœºæ¯”èµ›çš„åå­—
        const matchName = State.currentSeasonMatches.shift();
      const self = this; // åˆ›å»ºä¸€ä¸ªthisçš„åˆ«åï¼Œé˜²æ­¢åœ¨å›è°ƒå‡½æ•°ä¸­ä¸¢å¤±ä¸Šä¸‹æ–‡  
      
        // æ‰§è¡Œæ¯”èµ›é€»è¾‘
        this.runCompetitionLogic(matchName, (rank, score, sp, fs, rewardMoney, rewardFame, fatigue, envReport) => {
            
            // æ„å»ºå¼¹çª—æ˜¾ç¤ºä¿¡æ¯
            let info = `ã€${matchName} ç»“ç®—ã€‘<br> æ’åï¼šç¬¬ ${rank} å<br> çŸ­èŠ‚ç›®ï¼š${sp} <br>è‡ªç”±æ»‘ï¼š${fs} <br> æ€»åˆ†ï¼š${score} <br>èµ„é‡‘ï¼š+${rewardMoney} <br> åæ°”ï¼š+${rewardFame} <br> ä½“åŠ›ï¼š-${fatigue}`;
            
            // å¦‚æœæœ‰ç¯å¢ƒæ–‡æ¡ˆï¼Œè¿½åŠ æ˜¾ç¤º
            if (envReport) {
                info += `<br><div style="font-size: 13px; margin-top: 10px; text-align: left;">${envReport.replace(/\n/g, '<br>')}</div>`;
            }

            // å¤„ç† GP/JGP æ€»å†³èµ›æ™‹çº§é€»è¾‘
            if (matchName.includes("GP") && matchName.includes("ç«™")) { 
                State.gpRankings.push(rank);
                let canEnterFinal = false;
                if (State.gpRankings.length === 2) {
                    if (State.gpRankings[0] <= 3 && State.gpRankings[1] <= 3) canEnterFinal = true;
                } else if (State.gpRankings.length === 1 && State.seasonQualified === false) { 
                    if (State.gpRankings[0] <= 3) canEnterFinal = true;
                }

                if (canEnterFinal && !State.currentSeasonMatches.includes("JGPæ€»å†³èµ›") && !State.currentSeasonMatches.includes("GPæ€»å†³èµ›")) {
                  State.qualifiedForGPFinalThisSeason = true; // æ–°å¢ï¼šæ ‡è®°æœ¬èµ›å­£è·å¾—æ€»å†³èµ›èµ„æ ¼ 
                  if (State.group === 'youth') {
                        State.currentSeasonMatches.unshift("JGPæ€»å†³èµ›");
                        info += "<br><strong>è¡¨ç°ä¼˜å¼‚ï¼Œè·å¾— [JGPæ€»å†³èµ›] èµ„æ ¼ï¼</strong>";
                    } else {
                        State.currentSeasonMatches.unshift("GPæ€»å†³èµ›");
                        info += "<br><strong>è¡¨ç°ä¼˜å¼‚ï¼Œè·å¾— [GPæ€»å†³èµ›] èµ„æ ¼ï¼</strong>";
                    }
                }
            }

            // å¼¹å‡ºç»“ç®—çª—å£
            UI.showModal("æ¯”èµ›æˆ˜æŠ¥", info, () => {
                // 1. åˆ·æ–°ç•Œé¢ (è¿™æ˜¯å…³é”®ï¼šè¿™ä¼šè®©æŒ‰é’®æ–‡å­—æ ¹æ®å‰©ä½™èµ›ç¨‹è‡ªåŠ¨æ›´æ–°)
                // å¦‚æœæ²¡æ¯”èµ›äº†ï¼ŒæŒ‰é’®ä¼šå˜æˆ "èµ›å­£ç»“æŸ"ï¼Œç­‰å¾…ç©å®¶å†æ¬¡ç‚¹å‡»
                UI.updateDashboard(); 
// åœ¨æ¯”èµ›ç»“ç®—åï¼Œè°ƒç”¨â€œä¸»äº‹ä»¶æ£€æŸ¥å®˜â€
                self.masterEventCheck();
              
                // 2. æ£€æŸ¥æ­»äº¡/ç ´äº§æ¡ä»¶
                if (State.hp <= 0) {
                    UI.triggerEnding('hp_zero');
                    return; 
                }
                if (State.money < 0) {
                    UI.triggerEnding('bankrupt');
                    return; 
                }

// â–¼â–¼â–¼ æ ¸å¿ƒä¿®æ”¹ç‚¹ â–¼â–¼â–¼
    // æ£€æŸ¥èµ›å­£æ˜¯å¦è¿˜æœ‰å‰©ä½™æ¯”èµ›
    if (State.currentSeasonMatches.length > 0) {
        // å¦‚æœè¿˜æœ‰æ¯”èµ›ï¼Œåˆ™ç…§å¸¸è¿›è¡Œä¸€æ¬¡äº‹ä»¶æ£€æŸ¥
        self.masterEventCheck();
    } else {
        // å¦‚æœè¿™å·²ç»æ˜¯æœ€åä¸€åœºæ¯”èµ›ï¼Œåˆ™åªè®°å½•æ—¥å¿—ï¼Œä¸è¿›è¡Œäº‹ä»¶æ£€æŸ¥
        UI.log("æœ¬èµ›å­£èµ›ç¨‹å·²å…¨éƒ¨ç»“æŸã€‚");
    }
    // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²
              
            });
        });
    },

    // =================================================================
    // ã€é‡æ„ã€‘æ¯”èµ›ä¸»é€»è¾‘ï¼Œé›†æˆç¯å¢ƒç³»ç»Ÿ (å·²ä¿®å¤å˜é‡é¡ºåºä¸é€»è¾‘æ–­å±‚)
    // =================================================================
    runCompetitionLogic: function(matchName, callback) {
        // --- ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒæŠ½å–ä¸è®¡ç®— ---
        let chosenEnv = null;
        let envReport = "";

        // 1. ç¯å¢ƒæŠ½å¥–é€»è¾‘ (æ€»æ¦‚ç‡60%)
        if (Math.random() < 0.6) {
            let roll = Math.random(); 
            for (const env of CONFIG.matchModifiers) {
                if (roll < env.probability) {
                    chosenEnv = JSON.parse(JSON.stringify(env)); 
                    break; 
                }
                roll -= env.probability;
            }
        }

        // 2. å¤„ç†ç‰¹æ®Šåè½¬é€»è¾‘ ("å†·æ·¡è§‚ä¼—")
        if (chosenEnv && chosenEnv.id === 'cold_crowd' && chosenEnv.reversal) {
            if (chosenEnv.reversal.condition(State)) {
                chosenEnv.effect = chosenEnv.reversal.effect; 
                envReport = chosenEnv.desc + "\n" + chosenEnv.reversal.desc; 
            } else {
                envReport = chosenEnv.desc; 
            }
        } else if (chosenEnv) {
            envReport = chosenEnv.desc; 
        }
        
        // 3. è°ƒç”¨è®¡åˆ†å‡½æ•°
        const scores = this.calculateScores(chosenEnv);
        const bonus = State.tempMatchScoreBonus || 0; 
        const finalSP = scores.sp + bonus * 0.3;
        const finalFS = scores.fs + bonus * 0.7;
        const finalTotal = finalSP + finalFS;
        State.tempMatchScoreBonus = 0;

        // 4. å¤„ç†HPæ¶ˆè€—
        let fatigue = Math.floor(Math.random() * 6) + 5; 
        if (chosenEnv && chosenEnv.effect && chosenEnv.effect.extraHpCost) {
            fatigue += chosenEnv.effect.extraHpCost;
        }
        State.hp -= fatigue; 

        // --- ç¬¬äºŒæ­¥ï¼šç¡®å®šå¯¹æ‰‹å¼ºåº¦ (Config Selection) ---
        let config = null;
if (State.group === 'youth') {
    if (matchName.includes("JGP") && matchName.includes("ç«™")) config = CONFIG.matchConfig.youth.jgp;
    else if (matchName.includes("JGPæ€»å†³èµ›")) config = CONFIG.matchConfig.youth.final; // å˜å¾—æ›´å…·ä½“
    else if (matchName.includes("å…¨é’èµ›")) config = CONFIG.matchConfig.youth.nationals;
    else if (matchName.includes("é’å†¬å¥¥")) config = CONFIG.matchConfig.youth.olympics_youth;
    else if (matchName.includes("ä¸–é’èµ›")) config = CONFIG.matchConfig.youth.worlds; // å˜å¾—æ›´å…·ä½“
} else { // æˆå¹´ç»„
    if (matchName.includes("GP") && matchName.includes("ç«™")) config = CONFIG.matchConfig.adult.gp;
    else if (matchName.includes("GPæ€»å†³èµ›")) config = CONFIG.matchConfig.adult.final; // å˜å¾—æ›´å…·ä½“
    else if (matchName.includes("å…¨é”¦èµ›")) config = CONFIG.matchConfig.adult.nationals;
    else if (matchName.includes("å››å¤§æ´²")) config = CONFIG.matchConfig.adult['4cc'];
    else if (matchName.includes("äºšå†¬ä¼š")) config = CONFIG.matchConfig.adult.asiangames;
    else if (matchName.includes("ä¸–é”¦èµ›")) config = CONFIG.matchConfig.adult.worlds; // å˜å¾—æ›´å…·ä½“
    else if (matchName.includes("å†¬å¥¥ä¼š")) config = CONFIG.matchConfig.adult.olympics; // å˜å¾—æ›´å…·ä½“
}

// æ–°å¢ï¼šå¥å£®æ€§æ£€æŸ¥ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•é…ç½®ï¼Œå°±å‘å‡ºè­¦å‘Šå¹¶ä½¿ç”¨ä¸€ä¸ªåŸºç¡€é…ç½®ã€‚
if (!config) {
    console.error(`è­¦å‘Šï¼šæœªæ‰¾åˆ°æ¯”èµ› [${matchName}] çš„éš¾åº¦é…ç½®ï¼`);
    // ä½¿ç”¨ä¸€ä¸ªæœ€åŸºç¡€çš„é…ç½®ä½œä¸ºåå¤‡ï¼Œé˜²æ­¢æ¸¸æˆå´©æºƒ
    config = State.group === 'youth' ? CONFIG.matchConfig.youth.qualify : CONFIG.matchConfig.adult.qualify;
}

        // --- ç¬¬ä¸‰æ­¥ï¼šç¡®å®šå‚èµ›äººæ•° ---
        let totalParticipants;
        if (matchName.includes("æ€»å†³èµ›")) {
            totalParticipants = 6;
        } else if (matchName.includes("GP")) {
            totalParticipants = 12;
        } else if (matchName.includes("JGP")) {
            totalParticipants = 18;
        } else {
            totalParticipants = 24;
        }

        // --- ç¬¬å››æ­¥ï¼šè®¡ç®—æ’å ---
        let rank = 1;
        // æ¨¡æ‹Ÿå¯¹æ‰‹åˆ†æ•°å¹¶æ¯”è¾ƒ
        for(let i=0; i<totalParticipants-1; i++) {
            let npcSP = (config.base * 0.35) + (Math.random() * config.range * 0.35);
            let npcFS = (config.base * 0.65) + (Math.random() * config.range * 0.65);
            let npcTotal = npcSP + npcFS;
            if (npcTotal > finalTotal) rank++;
        }

        // --- ç¬¬äº”æ­¥ï¼šè®¡ç®—å¥–åŠ± ---
        let rewardMoney = Math.max(0, (totalParticipants - rank) * (State.group==='youth'?20:50));
        let rewardFame = 0;
        
        if (rank <= 3) {
          if(rank === 1) State.medalsThisSeason.G++;
        else if(rank === 2) State.medalsThisSeason.S++;
        else if(rank === 3) State.medalsThisSeason.B++;
          
          let baseFame = State.group==='youth' ? 150 : 400;
            if (rank === 2) baseFame *= 0.6;
            if (rank === 3) baseFame *= 0.4;
            if (matchName.includes("å†¬å¥¥")) baseFame *= 2.5;
            else if (matchName.includes("ä¸–é”¦")) baseFame *= 1.5;
            else if (matchName.includes("æ€»å†³èµ›")) baseFame *= 1.2;
            else if (matchName.includes("äºšå†¬ä¼š")) baseFame *= 1.1;

            rewardFame = Math.floor(baseFame);
            
            if (matchName.includes("å†¬å¥¥") && rank === 1) {
                State.hasOlympicGold = true;
                rewardMoney += 2000;
            }

            let key = (State.group === 'youth' ? 'i' : 'i') + (rank===1?'G':(rank===2?'S':'B'));
            State.medals[key]++;
        } else {
            rewardFame = Math.max(5, (totalParticipants - rank) * 2);
        }
      
 let psycheChange = 0;
    if (rank === 1) psycheChange = 5;
    else if (rank <= 3) psycheChange = 3;
    else if (rank > 10) psycheChange = -5;
    
    if (psycheChange !== 0) {
        this.updatePsyche(psycheChange);
    }
      
        State.money += rewardMoney;
        State.fame += rewardFame;
        
        UI.log(`å‚åŠ  ${matchName}ï¼Œæ’å${rank}ï¼ŒSP:${finalSP.toFixed(2)} FS:${finalFS.toFixed(2)}`);
        // --- æ–°å¢ï¼šè®°å½•æœ¬åœºæ¯”èµ›çš„ç»“æœ ---
      State.lastMatchResult = { name: matchName, rank: rank };
        // --- ç¬¬å…­æ­¥ï¼šå›è°ƒè¾“å‡ºç»“æœ (è¿™æ—¶å€™ rank å’Œ reward ç­‰å˜é‡éƒ½å·²ç»ç®—å¥½äº†) ---
        callback(rank, finalTotal.toFixed(2), finalSP.toFixed(2), finalFS.toFixed(2), rewardMoney, rewardFame, fatigue, envReport);
    },

    endSeason: function() {
        State.year++;
        State.shopLimits = { honey: 0, camp: 0 };

        if (State.group === 'youth' && State.year > 4) {
            State.group = 'adult';
            State.year = 5; 
            State.fame += 100;
            UI.showModal("å‡ç»„", "æ­å–œï¼ä½ å·²å‡å…¥æˆå¹´ç»„ã€‚æŒ‘æˆ˜æ›´å¼ºçš„å¯¹æ‰‹å§ï¼");
        }

        if (State.year > 12) {
            this.evaluateEnding();
            return;
        }

        State.phase = 'offseason';
        State.actionsLeft = 4;
        State.modifiers.camp = false; 

        let bodBonus = Math.floor(State.bod / 10) * 2;
        let dietBonus = State.modifiers.diet ? 10 : 0;
        let maxHp = 100 - State.hpCapMalus;
        State.hp = Math.min(maxHp, State.hp + 30 + bodBonus + dietBonus);

        let baseIncome = 100;
        if (State.fame > 100) baseIncome = 150;
        if (State.fame > 500) baseIncome = 300;
        if (State.fame > 1500) baseIncome = 600;
        if (State.fame > 4000) baseIncome = 1200;
        State.money += baseIncome;

      State.triggeredEventCount = 0;
    State.injuryImmunity = false;
    // â–¼â–¼â–¼ æ–°å¢ï¼šåœ¨æ­¤å¤„é‡ç½®å¹´åº¦ç»Ÿè®¡æ•°æ® â–¼â–¼â–¼
    State.trainsThisSeason = 0;
    State.restsThisSeason = 0;
    State.injuriesThisSeason = 0;
    State.qualifiedForGPFinalThisSeason = false;
    State.medalsThisSeason = { G: 0, S: 0, B: 0 };
        this.rollForContactEvents();    // ä¸ºæ–°çš„ä¸€å¹´æŠ½å–è”ç³»äººäº‹ä»¶
      
        UI.log(`æ–°çš„ä¸€å¹´å¼€å§‹äº†ã€‚èµ„é‡‘+${baseIncome}`);
        UI.updateDashboard();
    },

    evaluateEnding: function() {
        State.ended = true;
        UI.switchScreen('screen-ending');
        
        let title = "";
        let desc = "";

        if (State.hasOlympicGold && State.fame > 4000) {
            title = "å†°å›å¥³çš‡"; desc = "ä½ æˆä¸ºè·¨æ—¶ä»£çš„ä¼ å¥‡ï¼Œåå­—è¢«åˆ»åœ¨èŠ±æ»‘å†å²çš„ä¸°ç¢‘ä¸Šã€‚";
          } else if (State.art >= 90 && State.ins >= 80 && State.pow < 70) {
            title = "å†°ä¸Šç»‡æ¢¦è€…"; desc = "è™½ç„¶ä½ çš„è·³è·ƒéš¾åº¦ä»æœªè¾¾åˆ°é¡¶å³°ï¼Œä½†ä½ å¯¹éŸ³ä¹çš„ç†è§£å’Œå†°ä¸Šè¡¨æ¼”çš„åˆ›é€ åŠ›ï¼Œæ—©å·²è¶…è¶Šäº†æ—¶ä»£ã€‚é€€å½¹åï¼Œä½ æˆç«‹äº†è‡ªå·±çš„ç¼–èˆå·¥ä½œå®¤ï¼Œæ— æ•°æœªæ¥çš„å† å†›åœ¨ä½ çš„æŒ‡å¯¼ä¸‹ï¼Œå­¦ä¼šäº†å¦‚ä½•åœ¨å†°ä¸Šè®²è¿°åŠ¨äººçš„æ•…äº‹ã€‚ä½ æ²¡èƒ½æˆä¸ºæœ€å¼ºçš„é€‰æ‰‹ï¼Œä½†ä½ æˆä¸ºäº†æ— æ•°äººå¿ƒä¸­çš„èŠ±æ»‘è‰ºæœ¯å®¶ã€‚";
            } else if (State.ins >= 95 && State.art < 70 && State.pow < 65 && State.bod < 70 && !State.isGen2) {
            title = "å½©è›‹ç»“å±€ï¼šè±¡ç‰™å¡”ä¹‹å·…"; desc = "èŠ±æ ·æ»‘å†°å¯¹ä½ è€Œè¨€ï¼Œæ›´åƒæ˜¯ä¸€åœºå…³äºåŠ›å­¦ã€ç”Ÿç†å­¦å’Œç­–ç•¥åˆ†æçš„å¤æ‚å®éªŒã€‚ä½ ä»æœªå®Œå…¨æ²‰æµ¸äºèµ›åœºçš„å–§åš£ï¼Œè€Œæ˜¯ç—´è¿·äºå…¶èƒŒåçš„åŸç†ã€‚é€€å½¹åï¼Œä½ æ¯…ç„¶é‡è¿”æ ¡å›­ï¼Œå°†ä½ åœ¨å†°åœºä¸Šé”»ç‚¼å‡ºçš„æƒŠäººåˆ†æèƒ½åŠ›å’Œä¸“æ³¨åŠ›æŠ•å…¥å­¦æœ¯ç ”ç©¶ã€‚å¤šå¹´åï¼Œä½ çš„åå­—ä¸ä»…å‡ºç°åœ¨èŠ±æ»‘é€‰æ‰‹çš„åå•ä¸Šï¼Œè¿˜æ˜¯å‡ºç°åœ¨äº†è¯ºè´å°”å¥–çš„è·å¥–æ™šå®´ä¸­ã€‚";
            } else if (State.fame > 4000) {
            title = "æ—¶ä»£æ ‡å¿—"; desc = "è™½ç„¶ç¼ºå°‘ä¸€æšå¥¥è¿é‡‘ç‰Œï¼Œä½†ä½ æ˜¯å¤§ä¼—å…¬è®¤çš„å†°ä¸Šå·¨æ˜Ÿã€‚";
        } else if (State.fame > 1500 && (State.medals.iG + State.medals.iS + State.medals.iB) > 1) {
            title = "å›½é™…åå°†"; desc = "ä½ å¤šæ¬¡ç™»ä¸Šé¢†å¥–å°ï¼Œæ˜¯æ´»è·ƒäºå›½é™…èµ›åœºçš„é¡¶å°–é€‰æ‰‹ã€‚";
        } else if (State.fame > 500) {
            title = "çŸ¥åæ•™ç»ƒ"; desc = "ä½ çš„èŒä¸šç”Ÿæ¶¯ç¨³å®šè€Œå¹³æ·¡ï¼Œé€€å½¹åæˆä¸ºå¤‡å—å°Šæ•¬çš„é¡¶çº§æ•™ç»ƒã€‚";
        } else if (State.fame > 100) {
            title = "å›½å†…åå°†"; desc = "ä½ åœ¨å›½å†…èµ›åœºç•™ä¸‹äº†æµ“å¢¨é‡å½©çš„ä¸€ç¬”ï¼Œæ˜¯çœé˜Ÿçš„éª„å‚²ã€‚";
        } else {
            title = "å†°åœºè¿‡å®¢"; desc = "ä½ æ›¾ç»æ˜¯è¿åŠ¨å‘˜ï¼Œæœ€ç»ˆå›å½’æ™®é€šäººçš„å¹³æ·¡ç”Ÿæ´»ã€‚";
        }

        document.getElementById('end-title').innerText = title;
        document.getElementById('end-desc').innerText = desc;
        
        let badges = [];
        if (State.pow >= 100 || State.art >= 100 || State.ins >= 100) badges.push("ã€ä¸“é¡¹å¤©æ‰ã€‘");
        // æˆå°±åˆ¤æ–­é€»è¾‘
        const stats = { 'çˆ†å‘': State.pow, 'è‰ºæœ¯': State.art, 'ä½“é­„': State.bod, 'çµæ„Ÿ': State.ins };
        const maxStat = Object.keys(stats).reduce((a, b) => stats[a] > stats[b] ? a : b);
        const minStatVal = Math.min(State.pow, State.art, State.bod, State.ins);
        const maxStatVal = Math.max(State.pow, State.art, State.bod, State.ins);
        const diff = maxStatVal - minStatVal;

        if (State.art >= maxStatVal) badges.push("ã€æ»‘è¡¨ä¹‹ç¥ã€‘");
        if (State.pow >= maxStatVal) badges.push("ã€äººä¸­å¼¹ç°§ã€‘");
        if (State.bod >= maxStatVal) badges.push("ã€å†°ä¸Šæ°¸åŠ¨æœºã€‘");
        if (State.ins >= maxStatVal) badges.push("ã€å¤§æ•°å­¦å®¶ã€‘");
        
        if (minStatVal > 85 && diff < 3) badges.push("ã€å…­è¾¹å½¢æˆ˜å£«ã€‘");
        if (diff > 20) badges.push("ã€åç§‘æˆ˜ç¥ã€‘");
        if (State.fame > 5000) badges.push("ã€èŠ±æ»‘æ˜æ˜Ÿã€‘");

        if (State.heavyInjuryCount === 0) badges.push("ã€é’¢é“ä¹‹èº¯ã€‘");
        if (State.luckyFish) badges.push("ã€å¥‡è¿¹é”¦é²¤ã€‘");
      if (State.hasBadgeSoftHeart) badges.push("ã€å¿ƒè½¯ã®ç¥ã€‘"); // æ–°å¢æˆå°±
      if (State.totalRestsAllTime > 24) badges.push("ã€åŠ³é€¸ç»“åˆã€‘");
if (State.totalRestsAllTime < 10) badges.push("ã€æ°¸åŠ¨æœºã€‘");
        if (State.hasOlympicGold && State.medals.iG >= 3) badges.push("ã€å…¨æ»¡è´¯ã€‘");
        
        document.getElementById('end-badges').innerText = badges.join(" ");
        document.getElementById('end-stats-summary').innerText = 
            `æœ€ç»ˆå±æ€§: çˆ†å‘${Math.floor(State.pow)} / è‰ºæœ¯${Math.floor(State.art)} / ä½“é­„${Math.floor(State.bod)} / çµæ„Ÿ${Math.floor(State.ins)} | åæ°”: ${State.fame}`;
    },

    triggerEnding: function(type) {
        State.ended = true;
        UI.switchScreen('screen-ending');
        if (type === 'wind') {
            document.getElementById('end-title').innerText = "å½©è›‹ç»“å±€ï¼šé£çš„ä¼ äºº";
            document.getElementById('end-desc').innerText = "ä½ è„±ä¸‹äº†è€ƒæ–¯æ»•ï¼Œæ¢ä¸Šäº†ç´§èº«çš„é€Ÿåº¦æ»‘å†°æœã€‚å‡ å¹´åï¼Œè™½ç„¶èŠ±æ»‘èµ›åœºå°‘äº†ä¸€ä¸ªå¤©æ‰ï¼Œä½†çŸ­é“é€Ÿæ»‘çš„ä¸–ç•Œçºªå½•é‡Œï¼Œå¤šäº†ä¸€ä¸ªå±äºä½ çš„åå­—ã€‚";
        } else if (type === 'injury') {
            document.getElementById('end-title').innerText = "ç»“å±€ï¼šé—æ†¾ç¦»åœº";
            document.getElementById('end-desc').innerText = "ç”±äºä¼¤ç—…ï¼Œä½ é—æ†¾ç¦»å¼€äº†èŒä¸šèµ›åœºã€‚";
        }
    }, // <--- 1. æ³¨æ„è¿™é‡Œï¼ä¸ºäº†è¿æ¥ä¸‹é¢çš„æ–°å‡½æ•°ï¼Œæˆ‘åŠ äº†ä¸€ä¸ªè‹±æ–‡é€—å·
    // ã€æ–°å¢ã€‘å¿ƒæ€æ›´æ–°æ ¸å¿ƒå‡½æ•°ï¼ˆå«çµæ„Ÿè¡°å‡ï¼‰
    updatePsyche: function(baseChange) {
        // è¡°å‡å…¬å¼ï¼šçµæ„Ÿè¶Šé«˜ï¼Œå¿ƒæ€å˜åŒ–è¶Šå°
        // çµæ„Ÿ0 -> å˜åŒ–*1.0ï¼›çµæ„Ÿ100 -> å˜åŒ–*0.6ï¼›çµæ„Ÿ250(ç†è®ºæé™) -> å˜åŒ–*0
        let dampener = 1 - (State.ins / 250);
        if (dampener < 0) dampener = 0; // é˜²æ­¢è´Ÿæ•°
        
        let finalChange = baseChange * dampener;
        
        // æ›´æ–°å¹¶é™åˆ¶åœ¨ 0-100
        State.psyche = Math.max(0, Math.min(100, State.psyche + finalChange));
       if (State.psyche <= 0 && !State.ended) {
        UI.triggerEnding('mental_breakdown');}
    },
    /* --- [æ–°å¢åŠŸèƒ½] å±æ€§ä¸Šé™ç»Ÿä¸€ç®¡ç†å™¨ --- */
    enforceMaxStats: function() {
        // å®šä¹‰æˆ‘ä»¬éœ€è¦é™åˆ¶çš„å››ä¸ªæ ¸å¿ƒå±æ€§
        const limits = ['art', 'bod', 'pow', 'ins'];
        
        // éå†è¿™å››ä¸ªå±æ€§ï¼Œé€ä¸€æ£€æŸ¥
        limits.forEach(key => {
            // å¦‚æœå±æ€§å­˜åœ¨ä¸”è¶…è¿‡äº† 100
            if (State[key] > 100) {
                State[key] = 100; // å¼ºåˆ¶è®¾ä¸º 100
            }
        });
        
        // é¡ºä¾¿ä¹Ÿå¯ä»¥æŠŠ HP çš„ä¸Šé™æ£€æŸ¥æ”¾åœ¨è¿™é‡Œï¼ˆå¯é€‰ï¼‰ï¼Œä¿æŒé€»è¾‘ç»Ÿä¸€
        let maxHp = 100 - State.hpCapMalus;
        if (State.hp > maxHp) State.hp = maxHp;
    }
    /* --- [æ–°å¢ç»“æŸ] --- */
};



/* ============================================================
   5. ç•Œé¢æ§åˆ¶ (UI Controller)
   ============================================================ */
const UI = {
    switchScreen: function(screenId) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    },

    renderPrologue: function() {
        const stepData = CONFIG.prologue[State.step];
        const container = document.getElementById('prologue-step-content');
        let html = `<p>${stepData.desc}</p>`;
        
        stepData.options.forEach((opt, idx) => {
            html += `<button class="btn" onclick="Game.choosePrologue(${idx})"><strong>${opt.txt}</strong><small>${opt.tag}</small></button>`;
        });
        container.innerHTML = html;
    },

    updateStory: function(text, options) {
        document.getElementById('story-text').innerHTML = text;
        const btnContainer = document.getElementById('story-options');
        btnContainer.innerHTML = '';
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.innerText = opt.txt;
            btn.onclick = () => { opt.action(btn); };
            btnContainer.appendChild(btn);
        });
    },

    showModal: function(title, content, onConfirm = null) {
        document.getElementById('modal-title').innerText = title;
        // ã€ä¿®æ”¹ã€‘ä» .innerText æ”¹ä¸º .innerHTMLï¼Œè¿™æ ·å®ƒå°±èƒ½è§£æHTMLæ ‡ç­¾äº†
        document.getElementById('modal-content').innerHTML = content;
        const overlay = document.getElementById('modal-alert');
        const btn = document.getElementById('modal-btn');
        overlay.style.display = 'flex';
        btn.onclick = function() {
            overlay.style.display = 'none';
            if (onConfirm) onConfirm();
        };
    },

    initDashboard: function() {
        const trainContainer = document.getElementById('training-buttons');
        trainContainer.innerHTML = '';
        CONFIG.trainings.forEach(t => {
            const btn = document.createElement('button');
            btn.className = 'mode-btn';
            btn.id = `train-btn-${t.id}`;
            btn.innerHTML = `${t.name}<br><span style="color:#636e72">${t.desc}</span>`;
            btn.onclick = () => {
                State.selectedTrainingId = t.id;
                UI.highlightTraining(t.id);
            };
            trainContainer.appendChild(btn);
        });

        const intensityContainer = document.getElementById('intensity-selector');
        intensityContainer.innerHTML = `
            <button class="mode-btn" id="int-recover" onclick="UI.setIntensity('recover')">æ¢å¤ä¼‘é—²<br>x0.5 (+5HP)</button>
            <button class="mode-btn selected" id="int-normal" onclick="UI.setIntensity('normal')">å¸¸è§„è®­ç»ƒ<br>x1.0 (-10HP)</button>
            <button class="mode-btn" id="int-sprint" onclick="UI.setIntensity('sprint')">å†²åˆºçªå‡»<br>x1.2 (-15HP)</button>
        `;
        this.updateDashboard();
    },

    highlightTraining: function(id) {
        document.querySelectorAll('#training-buttons .mode-btn').forEach(b => b.classList.remove('selected'));
        const btn = document.getElementById(`train-btn-${id}`);
        if(btn) btn.classList.add('selected');
    },

    setIntensity: function(mode) {
        State.selectedIntensity = mode;
        document.querySelectorAll('#intensity-selector .mode-btn').forEach(b => b.classList.remove('selected'));
        document.getElementById(`int-${mode}`).classList.add('selected');
    },

    updateDashboard: function() {
        document.getElementById('ui-year').innerText = `ç¬¬${State.year}å¹´ ${State.group === 'youth' ? 'é’å¹´ç»„' : 'æˆå¹´ç»„'} Â· ${State.phase === 'offseason' ? 'ä¼‘èµ›æœŸ' : 'èµ›å­£'}`;
        
        let targetText = State.group === 'youth' ? 'å‡ç»„' : 'å†¬å¥¥ä¼š';
        let targetYear = State.group === 'youth' ? 5 : (State.year <= 8 ? 8 : 12);
        let yearsLeft = targetYear - State.year;
        document.getElementById('ui-target').innerText = `è·${targetText}è¿˜æœ‰ ${yearsLeft} å¹´`;

        document.getElementById('ui-medals').innerText = `ğŸ¥‡${State.medals.iG} ğŸ¥ˆ${State.medals.iS} ğŸ¥‰${State.medals.iB}`;
        document.getElementById('ui-res').innerText = `ğŸ’° ${State.money}`;
        document.getElementById('ui-actions-left').innerText = `å‰©ä½™æ¬¡æ•°: ${State.actionsLeft}`;

        const trainBtn = document.getElementById('btn-do-train');
        trainBtn.disabled = (State.actionsLeft <= 0);

        if (State.hp <= 29) {
            trainBtn.innerText = "èº«ä½“é€æ”¯ (ä»…èƒ½ä¼‘æ¯)";
            // æ³¨æ„ï¼šæŒ‰é’®è™½ç„¶äº®ç€ï¼Œä½†å¦‚æœç©å®¶ç‚¹çš„ä¸æ˜¯â€œä¼‘æ¯â€ï¼Œä¼šåœ¨ handleTraining é‡Œè¢«æ‹¦æˆª
        } else {
            trainBtn.innerText = "å¼€å§‹è®­ç»ƒ";
        }

        const phaseBtn = document.getElementById('btn-phase');
        if (State.phase === 'offseason') {
            phaseBtn.innerText = "å¼€å§‹èµ›å­£ (é€‰æ‹”èµ›)";
            phaseBtn.disabled = (State.actionsLeft > 0); 
        } else {
            if (State.currentSeasonMatches.length > 0) {
                phaseBtn.innerText = `ç«™ä¸Šèµ›åœº: ${State.currentSeasonMatches[0]}`;
                phaseBtn.disabled = false;
            } else {
                phaseBtn.innerText = "èµ›å­£ç»“æŸ";
                phaseBtn.disabled = false;
            }
        }

        const renderBar = (label, val, color, extra = '') => {
            return `
            <div class="stat-row">
                <div class="stat-label">${label} ${extra}</div>
                <div class="progress-bg">
                    <div class="progress-fill" style="width: ${Math.min(100, val)}%; background-color: ${color}"></div>
                    <div class="marker" style="left:60%"></div>
                    <div class="marker" style="left:85%"></div>
                </div>
                <div class="stat-val">${val.toFixed(1)}</div>
            </div>`;
        };

        let hpColor = State.hp >= 70 ? 'var(--hp-high)' : (State.hp >= 30 ? 'var(--hp-mid)' : 'var(--hp-low)');
        let bodExtra = `<span style="color:#d63031; font-size:10px;">â™¥+${Math.floor(State.bod/10)*2}</span>`;

        let html = "";
        html += renderBar("HP", State.hp, hpColor, `/${100-State.hpCapMalus}`);
        html += renderBar("çµæ„Ÿ", State.ins, 'var(--ins-color)');
        html += renderBar("è‰ºæœ¯", State.art, 'var(--art-color)');
        html += renderBar("ä½“é­„", State.bod, 'var(--bod-color)', bodExtra);
        html += renderBar("çˆ†å‘", State.pow, 'var(--pow-color)');
        html += renderBar("åæ°”", Math.min(100, State.fame / 4000 * 100), '#f1c40f', `(${State.fame})`);

              // ... html += renderBar("çˆ†å‘", ...); ä¹‹å ...

        // ã€æ–°å¢ã€‘å¿ƒæ€æ¡æ¸²æŸ“
        // æ ¹æ®æ•°å€¼å†³å®šé¢œè‰²
        let psycheColor = '#00b894'; // é»˜è®¤ç»¿è‰²(å¹³å’Œ)
        let psycheLabel = "å¹³å’Œ";
        
        if (State.psyche < 10) { psycheColor = '#2c3e50'; psycheLabel = "å´©æºƒ"; } // æ·±è“
        else if (State.psyche < 30) { psycheColor = '#74b9ff'; psycheLabel = "ç„¦è™‘"; } // æµ…è“
        else if (State.psyche < 70) { psycheColor = '#00b894'; psycheLabel = "å¹³å’Œ"; } // ç»¿
        else if (State.psyche < 90) { psycheColor = '#e17055'; psycheLabel = "è‡ªä¿¡"; } // æ©™
        else { psycheColor = '#d63031'; psycheLabel = "ç‹‚çƒ­"; } // çº¢

        // å¤ç”¨ renderBar å‡½æ•°ï¼Œä½†åœ¨ label ååŠ çŠ¶æ€æè¿°
        html += renderBar("å¿ƒæ€", State.psyche, psycheColor, `(${psycheLabel})`);
     
        document.getElementById('ui-stats').innerHTML = html;
        },

    log: function(msg) {
        const box = document.getElementById('activity-log');
        const div = document.createElement('div');
        div.className = 'log-item';
        div.innerText = msg;
        box.prepend(div);
    },

    openShop: function() {
        const list = document.getElementById('shop-list');
        document.getElementById('shop-money').innerText = State.money;
        list.innerHTML = '';
        
        let discount = 1.0;
        if (State.fame > 4000) discount = 0.8;
        else if (State.fame > 1500) discount = 0.85;
        else if (State.fame > 500) discount = 0.9;
        else if (State.fame > 100) discount = 0.95;

        CONFIG.shopItems.forEach(item => {
            if (item.minGroup === 'adult' && State.group === 'youth') return;
            if (item.oneTime && (
                (item.id === 'skates' && State.modifiers.skates) || 
                (item.id === 'diet' && State.modifiers.diet)
            )) return;

            const realCost = Math.floor(item.cost * discount);
            const canBuy = State.money >= realCost;
            
            // æ£€æŸ¥å¹´åº¦é™è´­
            let limitTxt = "";
            let isLimitReached = false;
            if (item.limit) {
                const count = State.shopLimits[item.id] || 0;
                limitTxt = `<br><span style="color:#e17055; font-size:10px">(æœ¬å¹´å‰©ä½™: ${item.limit - count}/${item.limit})</span>`;
                if (count >= item.limit) isLimitReached = true;
            }

            const div = document.createElement('div');
            div.className = 'shop-item';
            div.innerHTML = `
                <div><strong>${item.name}</strong>${limitTxt}<br><small>${item.desc}</small></div>
                <button class="btn" style="width:80px; padding:5px; background:${(canBuy && !isLimitReached)?'#00b894':'#b2bec3'}" 
                    onclick="UI.buyItem('${item.id}', ${realCost})" ${(canBuy && !isLimitReached)?'':'disabled'}>${realCost}</button>
            `;
            list.appendChild(div);
        });
        document.getElementById('modal-shop').style.display = 'block';
    },

    closeShopModal: function() { document.getElementById('modal-shop').style.display = 'none'; },

    buyItem: function(itemId, cost) {
        // 1. æŸ¥æ‰¾å•†å“æ•°æ®
        const item = CONFIG.shopItems.find(i => i.id === itemId);
        if (!item) return;

        // 2. æ£€æŸ¥é‡‘é’±
        if (State.money < cost) {
            this.showModal("æç¤º", "èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•è´­ä¹°ï¼");
            return;
        }

        // 3. æ£€æŸ¥é™è´­é€»è¾‘ (limit)
        if (item.limit) {
            const count = State.shopLimits[itemId] || 0;
            if (count >= item.limit) {
                this.showModal("æç¤º", "è¯¥å•†å“ä»Šå¹´å·²è¾¾åˆ°è´­ä¹°ä¸Šé™ï¼");
                return;
            }
            State.shopLimits[itemId] = count + 1;
        }

        // 4. æ‰£é™¤é‡‘é’±
        State.money -= cost;

        // 5. æ ¹æ® ID æ‰§è¡Œå•†å“æ•ˆæœ
        switch (itemId) {
            case 'honey': // ç§˜åˆ¶èœ‚èœœæ°´
                State.hp = Math.min(100, State.hp + 10); // é˜²æ­¢è¶…è¿‡ 100
                this.showModal("è´­ä¹°æˆåŠŸ", "å–ä¸‹èœ‚èœœæ°´ï¼ŒHPæ¢å¤äº† 10 ç‚¹ï¼");
                break;
                
            case 'massage': // æ·±å±‚ç­‹è†œæª
                State.hp = Math.min(100, State.hp + 25);
                this.showModal("è´­ä¹°æˆåŠŸ", "æ·±å±‚è‚Œè‚‰å¾—åˆ°æ”¾æ¾ï¼ŒHPå¤§å¹…æ¢å¤ 25 ç‚¹ï¼");
                break;

            case 'shield': // é«˜çº§æŠ¤å…·
                State.modifiers.shield = true; // éœ€è¦åœ¨ State.modifiers é‡Œç¡®ä¿æœ‰è¿™ä¸ªå­—æ®µ
                this.showModal("è´­ä¹°æˆåŠŸ", "è£…å¤‡äº†æŠ¤å…·ï¼Œä¸‹æ¬¡å—ä¼¤æ¦‚ç‡å°†å‡åŠã€‚");
                break;

            case 'skates': // é¡¶çº§è¿›å£å†°é‹ (æ°¸ä¹…çµæ„ŸåŠ æˆ)
                State.modifiers.skates = true; // éœ€åœ¨æ¯”èµ›è®¡ç®—åˆ†æ•°çš„å…¬å¼é‡Œæ£€æµ‹è¿™ä¸ªæ ‡è®°
                this.showModal("è´­ä¹°æˆåŠŸ", "è£…å¤‡é¡¶çº§å†°é‹ï¼çµæ„ŸåŠ æˆå·²ç”Ÿæ•ˆã€‚");
                break;
            
            case 'diet': // ç§äººè¥å…»å¸ˆ (æ°¸ä¹…å›è¡€)
                State.modifiers.diet = true; // éœ€åœ¨æ¯å¹´ç»“ç®—é€»è¾‘é‡Œæ£€æµ‹è¿™ä¸ªæ ‡è®°
                this.showModal("è´­ä¹°æˆåŠŸ", "ç­¾çº¦è¥å…»å¸ˆï¼Œæ¯å¹´ä¼‘èµ›æœŸå°†è‡ªåŠ¨æ¢å¤æ›´å¤šå¥åº·ã€‚");
                break;

            case 'camp': // è‡ªè´¹å¤–è®­ (è®­ç»ƒæ•ˆæœ+20%)
                State.modifiers.camp = true;
                this.showModal("è´­ä¹°æˆåŠŸ", "å·²æŠ¥åå¤–è®­ï¼Œæœ¬å¹´åº¦è®­ç»ƒæ”¶ç›Šæå‡ 20%ï¼");
                break;
            
            case 'master_class': // ä¼ å¥‡å¤§å¸ˆè¯¾ (ç«‹å³å…¨å±æ€§+2)
                State.pow += 2;
                State.art += 2;
                State.ins += 2;
                State.bod += 2;
                this.showModal("è´­ä¹°æˆåŠŸ", "ç»è¿‡å¤§å¸ˆæŒ‡ç‚¹ï¼Œä½ çš„å…¨å±æ€§æå‡äº† 2 ç‚¹ï¼");
                break;

            case 'ballet_class': // å¤§å¸ˆçº§èŠ­è•¾è¯¾
                State.art += 3;
                this.showModal("è´­ä¹°æˆåŠŸ", "ä¼˜é›…çš„èŠ­è•¾è®­ç»ƒæå‡äº†ä½ çš„è‰ºæœ¯è¡¨ç°åŠ› (+3)ï¼");
                break;

            case 'lucky_charm': // å¥½è¿çº¢ç»³
                State.luckyFish = true; // å¯¹åº”åŸæœ¬ä»£ç é‡Œçš„ luckyFish æ ‡è®°
                this.showModal("è´­ä¹°æˆåŠŸ", "ä½©æˆ´äº†çº¢ç»³ï¼Œæ„Ÿè§‰è¿æ°”å˜å¥½äº†ï¼");
                break;
            
            case 'psychology': // å¿ƒç†è¾…å¯¼å¸ˆ
                State.ins += 1; // éœ€è¦åœ¨ State.modifiers é‡Œç¡®ä¿æœ‰è¿™ä¸ªå­—æ®µ
                this.showModal("è´­ä¹°æˆåŠŸ", "æ¥å—äº†å¿ƒç†è¾…å¯¼ï¼Œä½ åœ¨å†°åœºæ›´å†·é™äº†ã€‚");
                break;
            
            case 'cat_cafe':
                Game.updatePsyche(10);
                this.showModal("è´­ä¹°æˆåŠŸ", "å¯çˆ±çš„æ¯›èŒ¸èŒ¸æ²»æ„ˆäº†ä½ çš„å¿ƒã€‚ï¼ˆå¿ƒæ€+10ï¼‰");
                break;
            
           case 'movie_ticket':
                Game.updatePsyche(5);
                State.ins += 1;
                this.showModal("è´­ä¹°æˆåŠŸ", "ä¸€åœºç²¾å½©çš„ç”µå½±è®©ä½ æ”¶è·é¢‡ä¸°ã€‚ï¼ˆå¿ƒæ€+5ï¼Œçµæ„Ÿ+1ï¼‰");
                break;
            
          case 'short_trip':
                Game.updatePsyche(-20);
                State.hp += 5;
                this.showModal("è´­ä¹°æˆåŠŸ", "ç»™è‡ªå·±æ”¾ä¸ªå°å‡ï¼Œç²¾ç¥å¾—åˆ°äº†æå¤§æ”¾æ¾ã€‚ï¼ˆå¿ƒæ€-20ï¼ŒHP+5ï¼‰");
                break;
// --- æ–°å¢ç»“æŸ ---
            
            case 'costume': // é«˜å®šè€ƒæ–¯æ»•
                State.art += 3; // éœ€è¦åœ¨ State.modifiers é‡Œç¡®ä¿æœ‰è¿™ä¸ªå­—æ®µ
                this.showModal("è´­ä¹°æˆåŠŸ", "å®šåˆ¶è€ƒæ–¯æ»•è®©ä½ çš„è¡¨æ¼”æ›´åŠ¨äººäº†ï¼");
                break;
            
        // ... switch (itemId) ç»“æŸ ...
            default:
                this.showModal("è´­ä¹°æˆåŠŸ", "ä½ è´­ä¹°äº† " + item.name);
        }

        // 7. åˆ·æ–°ç•Œé¢
        Game.enforceMaxStats(); // ã€æ–°å¢ã€‘åœ¨åˆ·æ–°ç•Œé¢å‰ï¼Œå¼ºåˆ¶æ£€æŸ¥å¹¶ä¿®æ­£æ‰€æœ‰å±æ€§ä¸Šé™
        this.updateDashboard();
        this.openShop(); // åˆ·æ–°å•†åº—UIä»¥æ›´æ–°æŒ‰é’®çŠ¶æ€
    },

    showEventModal: function(evt) {
        const modal = document.getElementById('modal-event');
        // å¦‚æœäº‹ä»¶å¯¹è±¡evtæœ‰è‡ªå·±çš„æ ‡é¢˜(title)ï¼Œå°±ç”¨å®ƒçš„ï¼Œå¦åˆ™å°±ç”¨é»˜è®¤çš„â€œéšæœºäº‹ä»¶â€
        document.getElementById('event-title').innerText = evt.title || "éšæœºäº‹ä»¶";
        document.getElementById('event-desc').innerText = evt.text;
        const optContainer = document.getElementById('event-options');
        optContainer.innerHTML = '';

        evt.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.innerText = opt.label;
            btn.onclick = () => {
                const feedback = opt.effect(State);
                
                Game.enforceMaxStats(); // ã€æ–°å¢ã€‘äº‹ä»¶ç»“ç®—åï¼Œç«‹å³æ‰§è¡Œå±æ€§ä¸Šé™æ£€æŸ¥

                UI.showModal("äº‹ä»¶ç»“æœ", feedback);
                modal.style.display = 'none';
                UI.updateDashboard();
            };
            optContainer.appendChild(btn);
        });
        modal.style.display = 'block';
    },

    triggerEnding: function(type) {
        State.ended = true;
        UI.switchScreen('screen-ending');
        if (type === 'wind') {
            document.getElementById('end-title').innerText = "å½©è›‹ç»“å±€ï¼šé£çš„ä¼ äºº";
            document.getElementById('end-desc').innerText = "ä½ è„±ä¸‹äº†è€ƒæ–¯æ»•ï¼Œæ¢ä¸Šäº†ç´§èº«çš„é€Ÿåº¦æ»‘å†°æœã€‚å‡ å¹´åï¼Œè™½ç„¶èŠ±æ»‘èµ›åœºå°‘äº†ä¸€ä¸ªå¤©æ‰ï¼Œä½†çŸ­é“é€Ÿæ»‘çš„ä¸–ç•Œçºªå½•é‡Œï¼Œå¤šäº†ä¸€ä¸ªå±äºä½ çš„åå­—ã€‚";
        } else if (type === 'injury') {
            document.getElementById('end-title').innerText = "ç»“å±€ï¼šé—æ†¾ç¦»åœº";
            document.getElementById('end-desc').innerText = "ç”±äºä¼¤ç—…ï¼Œä½ é—æ†¾ç¦»å¼€äº†èŒä¸šèµ›åœºã€‚";
        }
      else if (type === 'idol') {
            document.getElementById('end-title').innerText = "å½©è›‹ç»“å±€ï¼šå¶åƒäººç”Ÿ";
            document.getElementById('end-desc').innerText = "è™½ç„¶å‘Šåˆ«äº†ç«æŠ€èµ›åœºï¼Œä½†å‡­å€Ÿç»ä½³çš„è‰ºæœ¯æ„Ÿï¼Œä½ æˆä¸ºäº†å…¨çƒç©ç›®çš„è¶…çº§çˆ±è±†ã€‚ä»æ­¤ï¼Œå†°é¢ä¸å†æ˜¯ä½ çš„æˆ˜åœºï¼Œä½†ä½ çš„ç’€ç’¨äººç”Ÿæ‰åˆšåˆšå¼€å§‹ã€‚";
        }
      else if (type === 'boss') {
            document.getElementById('end-title').innerText = "å½©è›‹ç»“å±€ï¼šå†°åœºå¤§äº¨";
            document.getElementById('end-desc').innerText = "å¾ˆéš¾è¯´ä½ æ˜¯å¦å¾æœäº†å†°é¢ï¼Œä½†ä½ ä¸€å®šå¾æœäº†æ•´ä¸ªä½“è‚²äº§ä¸šã€‚æ‰‹ä¸­çš„è´¢å¯Œè®©ä½ æˆä¸ºISUæœ€å¤§çš„èµåŠ©å•†ï¼Œæ‹¥æœ‰æ— é™çš„è¯è¯­æƒã€‚ç°åœ¨çš„ä½ ï¼Œä¸å†éœ€è¦é€šè¿‡è£åˆ¤çš„æ‰“åˆ†æ¥è¯æ˜è‡ªå·±â€”â€”å› ä¸ºä½ å·²ç»æˆä¸ºäº†è§„åˆ™çš„åˆ¶å®šè€…ã€‚";
        }
      else if (type === 'bankrupt') {
            document.getElementById('end-title').innerText = "ç»“å±€ï¼šæ— ç±³ä¹‹ç‚Š";
            document.getElementById('end-desc').innerText = "ä½ ç ´äº§äº†ï¼è¿™é¡¹çƒ§é’±çš„è¿åŠ¨æ®‹å¿åœ°é©±é€äº†ä½ ã€‚";
        }
      else if (type === 'hp_zero') {
            document.getElementById('end-title').innerText = "ç»“å±€ï¼šå¥åº·æœ€é‡è¦";
            document.getElementById('end-desc').innerText = "è™½ç„¶ISUæ—¶å¸¸è¡¨ç°å¾—åƒè¦è¿›å…¥ICUï¼Œä½†å¤±å»äº†å¥åº·çš„ä½ æˆ–è®¸å·²ç»ä¸è¿™é¡¹è¿åŠ¨æ— ç¼˜ã€‚";
        }
       else if (type === 'despair') {
            document.getElementById('end-title').innerText = "ç»“å±€ï¼šä¸€åœºç©º";
            document.getElementById('end-desc').innerText = "å†…å¤–äº¤å›°ï¼Œä½ çš„å¥åº·ä¸é‡‘é’±éƒ½ç¦»ä½ è€Œå»ã€‚";
        }
      else if (type === 'mental_breakdown') { // æ–°å¢ç»“å±€
    document.getElementById('end-title').innerText = "ç»“å±€ï¼šå¿ƒåŠ›äº¤ç˜";
    document.getElementById('end-desc').innerText = "æ—¥å¤ä¸€æ—¥çš„ç„¦è™‘å’Œå‹åŠ›å‹å®äº†ä½ ã€‚ä½ å†ä¹Ÿæ— æ³•ä»æ»‘å†°ä¸­æ‰¾åˆ°ä¹è¶£ï¼Œä¹Ÿå¤±å»äº†ç«™ä¸Šèµ›åœºçš„å‹‡æ°”ã€‚åœ¨æ— å°½çš„å†…è€—ä¸­ï¼Œä½ çš„å†°ä¸Šç”Ÿæ¶¯å°±æ­¤è½å¹•ã€‚";}
      else if (type === 'pairs') {
            document.getElementById('end-title').innerText = "å½©è›‹ç»“å±€ï¼šè½¬è¡Œï¼";
            document.getElementById('end-desc').innerText = "ä½ è¿…é€Ÿå‘ç°äº†è‡ªå·±åœ¨åŒäººæ»‘ä¸Šçš„å¤©èµ‹ã€‚è™½ç„¶å’Œä½ é¢„æƒ³ä¸­ä¸åŒï¼Œä½†ä½ æœ€ç»ˆç«™ä¸Šäº†ä½ æ¢¦ä¸­çš„é‚£åº§é¢†å¥–å°ã€‚";
        }
    }, // <--- 1. æ³¨æ„è¿™é‡Œï¼ä¸ºäº†è¿æ¥ä¸‹é¢çš„æ–°å‡½æ•°ï¼Œæˆ‘åŠ äº†ä¸€ä¸ªè‹±æ–‡é€—å·

    /* --- [æ–°å¢åŠŸèƒ½] å±æ€§ä¸Šé™ç»Ÿä¸€ç®¡ç†å™¨ --- */
    enforceMaxStats: function() {
        // å®šä¹‰æˆ‘ä»¬éœ€è¦é™åˆ¶çš„å››ä¸ªæ ¸å¿ƒå±æ€§
        const limits = ['art', 'bod', 'pow', 'ins'];
        
        // éå†è¿™å››ä¸ªå±æ€§ï¼Œé€ä¸€æ£€æŸ¥
        limits.forEach(key => {
            // å¦‚æœå±æ€§å­˜åœ¨ä¸”è¶…è¿‡äº† 100
            if (State[key] > 100) {
                State[key] = 100; // å¼ºåˆ¶è®¾ä¸º 100
            }
        });
        
        // é¡ºä¾¿ä¹Ÿå¯ä»¥æŠŠ HP çš„ä¸Šé™æ£€æŸ¥æ”¾åœ¨è¿™é‡Œï¼ˆå¯é€‰ï¼‰ï¼Œä¿æŒé€»è¾‘ç»Ÿä¸€
        let maxHp = 100 - State.hpCapMalus;
        if (State.hp > maxHp) State.hp = maxHp;
    }
    /* --- [æ–°å¢ç»“æŸ] --- */
};

// å¯åŠ¨æ¸¸æˆ
UI.renderPrologue();

</script>
</body>

</html>
